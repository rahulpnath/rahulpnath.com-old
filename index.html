<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
<meta name="description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />


<meta name="keywords" content=".NET, programming, rahul nath, rahul, C#" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rahulpnath.com">
  
<!-- Favicon -->
  <link href="/favicon.png" type="image/png" rel="icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
<!-- End Favicon -->
  <link href="http://feeds2.feedburner.com/rahulpnath" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <!-- Social media content metadata -->


<meta property="fb:admins" content="774780093" />
<meta property="og:title" content="Rahul Nath" />
<meta property="og:site_name" content="Rahul Nath" />
<meta property="og:url" content="http://rahulpnath.com/" />
<meta property="og:description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />
<meta property="og:author" content="https://www.facebook.com/774780093" />



<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:site" content="rahulpnath" />
<meta property="twitter:url" content="http://rahulpnath.com" />
<meta property="twitter:title" content="Rahul Nath" />
<meta property="twitter:description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />
<meta property="twitter:creator" content="rahulpnath" />



<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"
    integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU="
    crossorigin="anonymous">
</script>

<script nonce="anF1ZXJ5ZmFsbGJhY2s=">
    window.jQuery || 
    document.write('<script src="/javascripts/libs/jquery/jquery-2.0.3.min.js" crossorigin="anonymous" integrity="sha256-ruuHogwePywKZ7bI1vHGGs7ScbBLhkNUcSSeRjhSUko=">\x3C/script>')
</script>

<link 
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css"
    integrity="sha256-tf1yN1B2PrtzH5Ih5BPn1k1Y1RktwEDkIpLtPczMpzI="
    crossorigin="anonymous" />
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap-theme.min.css"
    integrity="sha256-NLECy3aJQJ/Rw8GArrH9PwuL8LR6slx0xC6v9XTmYak="
    crossorigin="anonymous" />


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43172163-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/apps">Apps</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="http://feeds2.feedburner.com/rahulpnath" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/cse" method="GET">
                    <input type="hidden" name="cx" value="013909293779229500224:v37rx6hsidk" />
                    <input name="ie" type="hidden" value="UTF-8">
                    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />
    <meta itemprop="url" content="http://rahulpnath.com" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-12-17T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Dec 17<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/programming/'>programming</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/exclude-certain-scripts-from-transaction-when-using-dbup/" itemprop="url">Exclude Certain Scripts From Transaction When Using DbUp</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Recently I had written about <a href="https://rahulpnath.com/blog/setting-up-dbup-in-azure-pipelines/">Setting Up DbUP in Azure Pipelines</a> at one of my clients. We had all our scripts run under <a href="https://dbup.readthedocs.io/en/latest/more-info/transactions/">Transaction Per Script</a> mode and was all working fine until we had to deploy some SQL scripts that cannot be run under a transaction. So now I have a bunch of SQL script files that can be run under a transaction and some (like the ones below - <a href="https://azure.microsoft.com/en-au/blog/full-text-search-is-now-available-for-preview-in-azure-sql-database/">Full-Text Search</a>) that cannot be run under a transaction. By default, if you run this using DbUp under a transaction you get the error message<span class="text-danger">
CREATE FULLTEXT CATALOG statement cannot be used inside a user transaction </span> and this is an <a href="https://github.com/DbUp/DbUp/issues/207">existing issue</a>.</p>

<figure class='code'><figcaption><span>Full Text Search Script</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="n">FULLTEXT</span> <span class="k">CATALOG</span> <span class="n">MyCatalog</span>
</span><span class='line'><span class="k">GO</span>
</span><span class='line'>
</span><span class='line'><span class="k">CREATE</span> <span class="n">FULLTEXT</span> <span class="k">INDEX</span>
</span><span class='line'><span class="k">ON</span>  <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Products</span><span class="p">]</span> <span class="p">([</span><span class="n">Description</span><span class="p">])</span>
</span><span class='line'><span class="k">KEY</span> <span class="k">INDEX</span> <span class="p">[</span><span class="n">PK_Products</span><span class="p">]</span> <span class="k">ON</span> <span class="n">MyCatalog</span>
</span><span class='line'><span class="k">WITH</span> <span class="n">CHANGE_TRACKING</span> <span class="n">AUTO</span>
</span><span class='line'><span class="k">GO</span>
</span></code></pre></td></tr></table></div></figure>


<p>One option would be to turn off transaction all together using <em>builder.WithoutTransaction()</em> (default transaction setting) and everything would work as usual. But in case you want each of your scripts to be run under a transaction you can choose either of the options below.</p>

<h3>Using Pre-Processors to Modify Script Before Execution</h3>

<p><a href="https://dbup.readthedocs.io/en/latest/more-info/preprocessors/">Script Pre-Processors</a> are an extensibility hook into DbUp and allows you to modify a script before it gets executed. So we can wrap each SQL script with a transaction before it gets executed. In this case, you have to configure your builder to run WithoutTransaction and modify each script file before execution and explicitly wrap with a transaction if required. Writing a custom pre-processor is quickly done by implementing the IScriptPreprocessor interface, and you get the contents of the script file to modify. In this case, all I do is check whether the text contains &lsquo;CREATE FULLTEXT&rsquo; and wrap with a transaction if it does not. You could use file-name conventions or any other rules of your choice to perform the check and conditionally wrap with a transaction.</p>

<figure class='code'><figcaption><span>Conditionally Apply Transaction</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ConditionallyApplyTransactionPreprocessor</span> <span class="p">:</span> <span class="n">IScriptPreprocessor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">string</span> <span class="n">contents</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">contents</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;CREATE FULLTEXT&quot;</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">InvariantCultureIgnoreCase</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">scriptWithoutGO</span> <span class="p">=</span> <span class="n">contents</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;GO&quot;</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">InvariantCultureIgnoreCase</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">modified</span> <span class="p">=</span>
</span><span class='line'>                <span class="err">$</span><span class="s">@&quot;</span>
</span><span class='line'><span class="s">BEGIN TRANSACTION   </span>
</span><span class='line'><span class="s">BEGIN TRY</span>
</span><span class='line'><span class="s">           {scriptWithoutGO}</span>
</span><span class='line'><span class="s">    COMMIT;</span>
</span><span class='line'><span class="s">END TRY</span>
</span><span class='line'><span class="s">BEGIN CATCH</span>
</span><span class='line'><span class="s">    ROLLBACK;</span>
</span><span class='line'><span class="s">    THROW;</span>
</span><span class='line'><span class="s">END CATCH&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="n">modified</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">contents</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using Multiple UpgradeEngine to Deploy Scripts</h3>

<p>If you are not particularly fine with tweaking the pre-processing step and want to use the default implementations of DbUp and still achieve keep transactions for you scripts where possible, you can use multiple upgraders to perform the job for you. Iterate over all your script files and then partition them into batches of files that need to be run under a transaction and those that can&rsquo;t be run under a transaction. As shown in the image below you will end up with multiple batches with alternating sets of transaction/non-transaction set of scripts. When performing the upgrade over a batch, set the <em>WithTransactionPerScript</em> on the builder conditionally. If any of the batches fail, you can terminate the database upgrade.</p>

<p><img src="/images/dbup_batches.png" alt="Script file batches" class="center" /></p>

<figure class='code'><figcaption><span>Execute all batches (Might not be production ready)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">canRunUnderTransaction</span> <span class="p">=</span> <span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">fileName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;FullText&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">belongsToCurrentBatch</span> <span class="p">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>      <span class="n">batch</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>        <span class="n">canRunUnderTransaction</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">First</span><span class="p">())</span> <span class="p">==</span> <span class="n">canRunUnderTransaction</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">batches</span> <span class="p">=</span> <span class="n">allScriptFiles</span><span class="p">.</span><span class="n">Aggregate</span>
</span><span class='line'>        <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;(),</span> <span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">belongsToCurrentBatch</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">LastOrDefault</span><span class="p">(),</span><span class="n">next</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">current</span><span class="p">.</span><span class="n">Last</span><span class="p">().</span><span class="n">Add</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">current</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="n">next</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">return</span> <span class="n">current</span><span class="p">;</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">batch</span> <span class="k">in</span> <span class="n">batches</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">includeTransaction</span> <span class="p">=</span> <span class="p">!</span><span class="n">batch</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">canRunUnderTransaction</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">PerformUpgrade</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">ToSqlScriptArray</span><span class="p">(),</span> <span class="n">includeTransaction</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">result</span><span class="p">.</span><span class="n">Successful</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Red</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Error</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ResetColor</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Green</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Success!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ResetColor</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">DatabaseUpgradeResult</span> <span class="nf">PerformUpgrade</span><span class="p">(</span>
</span><span class='line'>    <span class="n">SqlScript</span><span class="p">[]</span> <span class="n">scripts</span><span class="p">,</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">includeTransaction</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">DeployChanges</span><span class="p">.</span><span class="n">To</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SqlDatabase</span><span class="p">(</span><span class="n">connectionString</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">WithScripts</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">LogToConsole</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">includeTransaction</span><span class="p">)</span>
</span><span class='line'>        <span class="n">builder</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">WithTransactionPerScript</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">var</span> <span class="n">upgrader</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">upgrader</span><span class="p">.</span><span class="n">PerformUpgrade</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keeping all your scripts in a single place and automating it through the build-release pipeline is <a href="https://rahulpnath.com/blog/working-effectively-under-constraints/">something you need to strive for</a>. Hope this helps you to continue using DbUp even if you want to execute scripts that are a mix of transactional and non-transactional.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-12-11T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Dec 11<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/dot-net-core/'>.net core</a>, <a class='category' href='/blog/category/azure/'>azure</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/dot-net-core-api-and-azure-ad-groups-based-access/" itemprop="url">.Net Core Web App and Azure AD Groups Role based access</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Getting your application to provide capabilities based on the role of the User using the system is a common thing. When using Azure Active Directory (AD), the Groups feature allows organizing users of your system into different roles. In the applications that we build, the group information can be used to enable/disable functionality. For, e.g., if your application has the functionality to add new users you might want to restrict this to only users belonging to the administrator role.</p>

<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-groups-create-azure-portal">Adding new groups</a> can be done using the Azure portal. Select Group Type, <em>Security</em> as it is intended to provide permissions based on roles.</p>

<p><img src="/images/azure_ad_Groups.png" alt="Azure AD Add Group" class="center" /></p>

<p>For the Groups to be returned as part of the claims, the <em>groupMembershipClaims</em> property in application manifest needs to be updated. Setting it to <em>SecurityGroup</em> will return all SecurityGroups of the user.</p>

<figure class='code'><figcaption><span>Azure AD Manifest - Group Membership Claims</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;groupMembershipClaims&quot;</span><span class="p">:</span> <span class="s2">&quot;SecurityGroup&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For each group created an <em>ObjectId</em> is assigned to it which is what gets returned as part of the claims. You can either add it as part of your applications config file or use Microsoft Graph API to query the list of groups at runtime. Here I have chosen to keep it as part of the config file.</p>

<figure class='code'><figcaption><span>appsettings.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;AdGroups&quot;</span><span class="err">:</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;GroupName&quot;</span><span class="p">:</span> <span class="s2">&quot;Admin&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;GroupId&quot;</span><span class="p">:</span> <span class="s2">&quot;119f6fb5-a325-47f9-9889-ae6979e9e120&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;GroupName&quot;</span><span class="p">:</span> <span class="s2">&quot;Employee&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;GroupId&quot;</span><span class="p">:</span> <span class="s2">&quot;02618532-b2c0-4e58-a32e-e715ddf07f63&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all the groups and associated configuration setup, we can wire up the .Net Core web application to start using the groups from the claims to enable/disable features. Using the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-2.2">Policy-based authorization</a> capabilities of .Net core application we can wire up policies for all the groups we have.</p>

<blockquote><p><em><a href="https://docs.microsoft.com/en-us/aspnet/core/security/authorization/policies?view=aspnetcore-2.2">Role-based authorization and claims-based authorization</a> use a requirement, a requirement handler, and a pre-configured policy. These building blocks support the expression of authorization evaluations in code. The result is a richer, reusable, testable authorization structure.</em></p></blockquote>

<p>We have an <em>IsMemberOfGroupRequirement</em> class to represent the requirement for all the groups, the <em>IsMemberOfGroupHandler</em> that implements how to validate a group requirement. The Handler reads the current user&rsquo;s claims and checks it contains the objectId associated with the Group as a claim. If a match is found the requirement check is marked as a success. Since we want the request to continue to match for any other group requirements the requirement is not failed explicitly.</p>

<figure class='code'><figcaption><span>IsMemberOfGroup Requirement</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">IsMemberOfGroupRequirement</span> <span class="p">:</span> <span class="n">IAuthorizationRequirement</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">GroupId</span> <span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">GroupName</span> <span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">IsMemberOfGroupRequirement</span><span class="p">(</span><span class="kt">string</span> <span class="n">groupName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">groupId</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">GroupName</span> <span class="p">=</span> <span class="n">groupName</span><span class="p">;</span>
</span><span class='line'>        <span class="n">GroupId</span> <span class="p">=</span> <span class="n">groupId</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">IsMemberOfGroupHandler</span> <span class="p">:</span> <span class="n">AuthorizationHandler</span><span class="p">&lt;</span><span class="n">IsMemberOfGroupRequirement</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">HandleRequirementAsync</span><span class="p">(</span>
</span><span class='line'>        <span class="n">AuthorizationHandlerContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">IsMemberOfGroupRequirement</span> <span class="n">requirement</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">groupClaim</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Claims</span>
</span><span class='line'>             <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">claim</span> <span class="p">=&gt;</span> <span class="n">claim</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="s">&quot;groups&quot;</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>                 <span class="n">claim</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">requirement</span><span class="p">.</span><span class="n">GroupId</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">InvariantCultureIgnoreCase</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">groupClaim</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="n">context</span><span class="p">.</span><span class="n">Succeed</span><span class="p">(</span><span class="n">requirement</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Registering the policies for all the groups in the application&rsquo;s configuration file and the handler can be done as below. Looping through all the groups in the config we create a policy for each with the associated GroupName. It allows us to use the GroupName as the policy name at places where we want to restrict features for users belonging to that group.</p>

<figure class='code'><figcaption><span>Registering Policy and Handler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">services</span><span class="p">.</span><span class="n">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">adGroupConfig</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AdGroupConfig</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">_configuration</span><span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="s">&quot;AdGroups&quot;</span><span class="p">,</span> <span class="n">adGroupConfig</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">adGroup</span> <span class="k">in</span> <span class="n">adGroupConfig</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="p">.</span><span class="n">AddPolicy</span><span class="p">(</span>
</span><span class='line'>            <span class="n">adGroup</span><span class="p">.</span><span class="n">GroupName</span><span class="p">,</span>
</span><span class='line'>            <span class="n">policy</span> <span class="p">=&gt;</span>
</span><span class='line'>                <span class="n">policy</span><span class="p">.</span><span class="n">AddRequirements</span><span class="p">(</span><span class="k">new</span> <span class="n">IsMemberOfGroupRequirement</span><span class="p">(</span><span class="n">adGroup</span><span class="p">.</span><span class="n">GroupName</span><span class="p">,</span> <span class="n">adGroup</span><span class="p">.</span><span class="n">GroupId</span><span class="p">)));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IAuthorizationHandler</span><span class="p">,</span> <span class="n">IsMemberOfGroupHandler</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the policy is now as simple as decorating your controllers with the Authorize attribute and providing the required Policy names on it as shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Authorize(Policy = &quot;Admin&quot;)]</span>
</span><span class='line'><span class="na">[ApiController]</span>
</span><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AddUsersController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">....</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hope this helps you to setup Role-based functionality for your ASP.Net Core applications using Azure AD as authentication/authorization provider.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-12-10T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Dec 10<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/dot-net-core/'>.net core</a>, <a class='category' href='/blog/category/asp-dot-net/'>asp.net</a>, <a class='category' href='/blog/category/azure/'>azure</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/azure-ad-custom-attributes-and-optional-claims-from-an-asp-dot-net-application/" itemprop="url">Azure AD Custom Attributes and Optional Claims from an ASP.Net Application</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>When using Azure Active Directory for managing your users, it is a common requirement to add additional attributes to your Users like SkypeId, employee code, EmployeeId and similar. Even though this happens to be a common need, getting this done is not that straightforward. This post describes how you can get additional properties on User objects in Azure AD.</p>

<p>Recently when I had to do this at a client, we had users in Azure AD, the additional property, employeeCode for the user was available in an internal application which had the users Azure email-address mapped to it. We needed these to be synced across to the user Azure AD and make it available as part of claims for a Web site that uses <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/authentication-scenarios">Azure AD authentication</a></p>

<h3>Adding Custom Attribute using Directory Schema Extensions</h3>

<p>Azure AD user has a set of <a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-users-profile-azure-portal">default properties</a>, manageable through the Azure Portal. Any additional property to User gets added as an extension to the current user Schema. To add a new property we first need to <a href="https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-directory-schema-extensions#RegisterAnExtension">register an extension</a>. Adding a new extension can be done using the <a href="https://graphexplorer.azurewebsites.net/">GraphExplorer website</a>. You need to specify the appropriate directory name (e.g., <em>contoso.onmicrosoft.com</em>) and the applicationObjectId. The application object id is the Object Id of the AD application that the Web Application uses to authenticate with Azure AD.</p>

<blockquote><p><em><a href="https://docs.microsoft.com/en-us/graph/extensibility-overview#azure-ad-directory-schema-extensions">Azure AD supports</a> a similar type of extension, known as directory schema extensions, on a few directory object resources. Although you have to use the Azure AD Graph API to create and manage the definitions of directory schema extensions, you can use the Microsoft Graph API to add, get, update and delete data in the properties of these extensions.</em></p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">POST</span> <span class="err">https://graph.windows.net/contoso.onmicrosoft.com/applications/</span>
</span><span class='line'>    <span class="err">&lt;applicationObjectId&gt;/extensionProperties?api-version=</span><span class="mf">1.5</span> <span class="err">HTTP/</span><span class="mf">1.1</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;employeeCode&lt;optionalEnvironmentName&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;targetObjects&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;User&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The response gives back the fully-qualified extension property name, which is used to write values to the property. Usually the name is of the format <em>extension_&lt;adApplicationIdWithoutDashes>_extensionPropertyName</em></p>

<p>If you have multiple environments (like Dev, Test, UAT, Prod) all pointing to the same Active Directory, it is a good idea to append the environment name to the extension property. It avoids any bad data issues between environments as all these properties get written to the same User object. You can automate the above step using any scripting language of your choice if required.</p>

<h3>Setting Values for Custom Attributes</h3>

<p>Now that we have the extension property created on the AD application, we can set the property on the User object. If you want to set this manually, you can use the <a href="https://graphexplorer.azurewebsites.net/">GraphExplorer website</a> again to do this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">PATCH</span> <span class="err">https://graph.windows.net/contoso.onmicrosoft.com/users</span>
</span><span class='line'>        <span class="err">/jim@contoso.onmicrosoft.com?api-version=</span><span class="mf">1.5</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;extension_ab603c56068041afb2f6832e2a17e237_employeeCode&lt;optionalEnvironmentName&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;EMP124&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our case it was not a one-off case of updating the User object, so better wanted this to be automated. Employee codes were available from a database with the associated Azure AD email address. So we created a windows service job that would sync these codes to Azure AD. You can write to Azure AD schema extension properties using <a href="https://developer.microsoft.com/en-us/graph">Microsoft Graph API</a>. Add a reference to the <a href="https://www.nuget.org/packages/Microsoft.Graph">Microsoft Graph NuGet package</a>, and you are all set to go. For the Graph API to authenticate, use a different Azure AD app (separate to the one that you registered the extension property on, which the web app uses to authenticate), just because it needs additional permissions as well and it is a good idea to isolate that. Under Settings -> Required Permissions, Add Microsoft Graph and provide the relevant permissions for it to write the user&rsquo;s profile/directory data.</p>

<p><img
    src="/images/azureAd_GraphApi_Permissions.png"
    class="center"
    alt="Azure AD Graph API Permissions" /></p>

<figure class='code'><figcaption><span>Get Graph Api Client</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">GraphServiceClient</span><span class="p">&gt;</span> <span class="n">GetGraphApiClient</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">clientId</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;AppId&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;Secret&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">domain</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;Domain&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">credentials</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ClientCredential</span><span class="p">(</span><span class="n">clientId</span><span class="p">,</span> <span class="n">secret</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">authContext</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">AuthenticationContext</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;https://login.microsoftonline.com/{domain}/&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">await</span> <span class="n">authContext</span>
</span><span class='line'>        <span class="p">.</span><span class="n">AcquireTokenAsync</span><span class="p">(</span><span class="s">&quot;https://graph.microsoft.com/&quot;</span><span class="p">,</span> <span class="n">credentials</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">graphServiceClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GraphServiceClient</span><span class="p">(</span><span class="k">new</span> <span class="n">DelegateAuthenticationProvider</span><span class="p">((</span><span class="n">requestMessage</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">requestMessage</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Headers</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Authorization</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationHeaderValue</span><span class="p">(</span><span class="s">&quot;bearer&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">.</span><span class="n">AccessToken</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">graphServiceClient</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Update Extension Value</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">UpdateEmployeeCode</span><span class="p">(</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">employeeCodePropertyName</span><span class="p">,</span> <span class="n">GraphServiceClient</span> <span class="n">graphApiClient</span><span class="p">,</span> <span class="n">Employee</span> <span class="n">employee</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">dictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">employeeCodePropertyName</span><span class="p">,</span> <span class="n">employee</span><span class="p">.</span><span class="n">Code</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">await</span> <span class="n">graphApiClient</span><span class="p">.</span><span class="n">Users</span><span class="p">[</span><span class="n">employee</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">]</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Request</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">UpdateAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">User</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">AdditionalData</span> <span class="p">=</span> <span class="n">dictionary</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looping through all the employee codes, you can update all of them into Azure AD at regular intervals. To verify that the attributes are updated correctly, you can either use the Graph API client to read the extension property or use the Graph Explorer Website.</p>

<h3>Accessing Custom Attributes through Claims</h3>

<p>With the Azure AD updated with the employee code for each user, we can now set up the AD application to return the additional property as part of the claims, when the web application authenticates with it. The application manifest of the Azure AD application needs to be modified to return the extension property as part of the claims. By default <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-optional-claims#configuring-optional-claims">optionalClaims property</a> is set to null and you can update it with the below values.</p>

<p><img
    src="/images/AzureAd_schema_extension_optionalClaims.png"
    class="center" alt="Azure AD Application Manifest - Optional Claims" /></p>

<figure class='code'><figcaption><span>Optional Claims in Azure AD Application Manifest</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;optionalClaims&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;idToken&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;extension_&lt;id&gt;_employeeCodeLocal&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;essential&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;accessToken&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span class='line'>    <span class="nt">&quot;saml2Token&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>I updated the idToken property as the .Net Core Web Application was using JWT ID token. If you are unsure of what token you can use <a href="https://rahulpnath.com/blog/fiddler-free-web-debugging-proxy/">Fiddler</a> to find what kind of token is used (as shown below).</p>

<p><img src="/images/AzureAd_idToken.png" class="center" alt="Id token returned" /></p>

<p>With the optonalClaims set, the web application is all set to go. For an authenticated user (with the extension property set), the extension property is available as part of claims. The claim type will be &lsquo;<em>extn.employeeCode<optionalEnvironmentNam></em>&rsquo;. The below code can be used to extract the employee code from the claim.</p>

<figure class='code'><figcaption><span>Get Employee Code From Claim</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetEmployeeCode</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">claimsPrincipal</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">claimsPrincipal</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">claimsPrincipal</span><span class="p">.</span><span class="n">Claims</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">empCodeClaim</span> <span class="p">=</span> <span class="n">claimsPrincipal</span><span class="p">.</span><span class="n">Claims</span>
</span><span class='line'>        <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">claim</span> <span class="p">=&gt;</span> <span class="n">claim</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="s">&quot;extn.employeeCode&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">empCodeClaim</span><span class="p">?.</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<div class="alert alert-warning">
Usually, the claims start flowing through immediately. However, once it did happen to me that the claims did not come for over a long period. Not sure what I did wrong, but once I deleted and recreated the AD application, it started working fine.
</div>


<p>Although setting additional properties on Azure AD Users is a common requirement, setting it up is not that straight-forward. Hope the portal improves someday, and it would be as easy as setting a list of key-value properties as extension properties, and it would all seamlessly flow through as part of the claims. However, till that day, hope this helps you to set up extra information on your Azure AD users.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-12-03T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Dec 3<sup>rd</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/programming/'>programming</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/setting-up-dbup-in-azure-pipelines/" itemprop="url">Setting up DbUp in Azure Pipelines</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><a href="https://azure.microsoft.com/en-au/services/devops/pipelines/">Azure Pipelines</a> is part of the <a href="https://azure.microsoft.com/en-au/services/devops/">Azure Devops</a> offerings which enables you to continuously build test and deploy to any platform and cloud environments. It&rsquo;s been a while since this has been out and it&rsquo;s only recently that I have got a chance to play around with it at one of my clients. We use <a href="https://dbup.readthedocs.io/en/latest/">DBUp</a>, a .Net library to deploy schema changes to our SQL Server database. <em>It tracks which SQL scripts have been run already, and runs the change scripts that are needed to get your database up to date.</em></p>

<p>Setting up DbUp is very easy, and you can use the script straight from the <a href="https://dbup.readthedocs.io/en/latest/">docs</a> to get started. If you are using .Net core console application VS template to setup DbUp make sure to modify the return type of the main function to use int and to return the appropriate application exit codes (as from the script in the doc.) I made the mistake of removing the return statements, only to later realize that build scripts were successfully passing even though the DbUp scripts were failing.</p>

<div class="alert alert-warning">
If you are using the .Net Core console application VS template (like I did) make sure you modify the return type of the main function in Program.cs to int. 
</div>


<p>In Azure Pipelines I have the build step publish the build output as a zip artifact. Using this in the release pipeline is a 2 step process</p>

<h4><strong>1 - Extract Zip Package</strong></h4>

<p>Using the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/extract-files?view=vsts">Extract Files Task</a> extract the zip package from the build artifacts. You can specify a destination folder for the files to be extracted to (as shown below).</p>

<p><img src="/images/dbup_azure_pipelines_extract.jpg" class ="center" alt="Extract package"></p>

<h4><strong>2 - Execute DbUp Package</strong></h4>

<p>With the package extracted out into a folder, we can now execute the console application (using the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-run?tabs=netcore21#description">dotnet command line</a>) by passing in the connection string as a command line argument.</p>

<p><img src="/images/dbup_azure_pipelines_execute.jpg" class ="center" alt="Execute package"></p>

<p>You now have your database deployments automated through the Azure Pipelines.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-11-27T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Nov 27<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/tipow/'>tipow</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/azure-pipelines-how-to-find-remaining-build-minutes/" itemprop="url">Tip of the Week: Azure Pipelines - How to Find Remaining Free Build Minutes?</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>With <a href="https://azure.microsoft.com/en-us/services/devops/pipelines/">Azure Pipelines</a> you can continuosly build, test and deploy to any cloud platform. Azure Pipelines has multiple options to start based on your project. Even if you are developing a private application, Pipelines offers you 1 Free parallel job  with upto 1800 minutes per month  and also 1 Free self hosted with unlimited months (as it&rsquo;s anyway running on your infrastructure).</p>

<p>On the Microsoft-hosted CI/CD with 1800 minutes you might need to find the used/remaining time any time during the month. You can find the remaining minutes from the <a href="https://dev.azure.com/">Azure Devops portal</a> and select the relevant organization.</p>

<p><strong>Organization settings -> Retention and parallel jobs -> Parallel Jobs</strong></p>

<p><img src="/images/azure_devops_remaining_build_minutes.png" alt="Azure Devops Pipelines - Remaining Build Minutes"
    class ="center" /></p>

<p>Hope that helps you find the remaining free build minutes for your organization!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-09-22T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Sep 22<sup>nd</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/thoughts/'>thoughts</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/working-effectively-under-constraints/" itemprop="url">Working Effectively Under Constraints</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>At times you might be working in environments where there are a lot of restrictions on the tools that you can use, the process that you need to follow, etc. Under these circumstances, it is essential that we stick to some core and fundamental principles and practices that we as an industry have adopted. We need to make sure that we have that in place no matter what the restrictions imposed are. Below are a few of the restrictions that I along with my team had to face at one of the clients and what we did to keep ourselves on top of it and still deliver at a higher speed.</p>

<p><img src="/images/working_constraints.png" alt="Working under Constraints." title="Working under Constraints. Image Source - https://www.saba.com/blog/how-to-master-employee-engagement-constraints"></p>

<blockquote><p><em>The issues discussed might or might not immediately relate to you, the important thing is your attitude towards such issues and finding ways around your constraints, keeping yourself productive on the long run.</em></p></blockquote>

<h3>No Build Deploy Pipeline</h3>

<p>When I joined the project, it amazed that we were still building/packaging the application from a local developer system and manually deploying this to the various environments (Dev, Test, UAT, and PROD).</p>

<blockquote><p><em>Whenever a release was to be made one of the developers was to pause his current work, switch to the appropriate branch for the release, make sure he had the latest code base, build with the correct configuration to generate a package.</em></p></blockquote>

<p>This might sound an outdated practice (as it did to me) but here I am at a client, in the year 2018 and it&rsquo;s still happening. What surprised me, even more, was that the team did have access to an <a href="https://octopus.com/">Octopus</a> server (backed by a <a href="https://jenkins.io/">Jenkins</a> build server) but since the <strong>deployment server did not have access to UAT/PROD servers</strong> they chose not to use it. You bet this was the first thing I was keen on fixing, as generating a release package from my local system would be the last thing that I want to do.</p>

<p>After a quick chat with the team, we decided on the below.</p>

<ul>
<li><p><strong>Set up build/deploy pipeline up to Test environment.</strong> This would allow seamless integration while we are developing features and get it out for testing. Since we had access till the Test environment, this was hardly an hours work to get it all working.</p></li>
<li><p>Since we did not have access to UAT/PROD and the process required us to hand over a deployment package to the concerned team, we <strong>set up a &lsquo;Packaging Project&rsquo; in Octopus.</strong> This project basically unzips the selected build package into our Dev environment server, applies the configuration transforms and zips up the folder into a deployment package. With this, we are now able to create a deployment package for any given build and for any environment. We are also having discussions to enable access to UAT/PROD servers for the deployment servers so that we can deploy automatically, all the way to production.</p></li>
</ul>


<p>No longer was the process dependent on a developer or a developer machine and was completely automated. For those reading this and in a similar situation but who does not have access to a build/deploy system like Jenkins/Octopus I would basically set up a simple script to pull down the source given a commit hash/branch/tfs label and perform a build and package independent of the working directory of the developer. This script could run on a shared server (if you have access to one) or worst on a developer&rsquo;s machine/VM. The fundamental thing that we are trying to achieve is to decouple it from the current working folder on a developer machine and the manual steps involved in generating a package. As long as you have an automated way to create a package irrespective of what tools/systems you use we should be safe and sound.</p>

<h3>Out of Sync SQL and Code Artifacts</h3>

<p>The application is heavily dependent on Stored Procedures for pulling/pushing data out of the SQL Server Database. Yes, you heard it right, Stored Procedures and ones with business logic in them, which is what makes it actually worse. Looking at how the Stored Procedures were maintained I could see that the team started off with good intentions using <a href="https://dbup.readthedocs.io/en/latest/">DbUp</a> but soon moved away from it. When I joined the process was to share SQL artifacts as attachments in the <a href="https://www.atlassian.com/software/jira">Jira</a> story/bug. The Db Administrator (DBA) would then pull that out and manage them separately in a source control repository that was not the same as the application code base.</p>

<p>There was not much information on why this was the case, but the primary reason that they moved away from DbUp was that there was no visibility of the SQL scripts when running updates as it was an executable file that was the output of the DbUp project. Also, there were poor development/deployment practices that led to the ad-hoc execution of scripts in environments without actually updating the source control. This soon put the DBA out of control, and the only way to gain control back was to maintain it separately.</p>

<p>Again we decided to have a quick chat with the team along with the DBA on how to improve the current process, as it was getting harder to track application package versions and the associated scripts to go with that package.</p>

<ul>
<li><p>DbUp by default embeds the SQL artifacts into the executable which removes all visibility into the actual scripts. However, this behaviour is configurable using <a href="https://dbup.readthedocs.io/en/latest/more-info/script-providers/">ScriptProviders</a>. By using the <strong>FileSystemScriptProvider, we can specify the folder from which to load the SQL scripts</strong>. Configuring the msbuild to copy out all the folder files to the output and including them into the final package was an easy change. This provided the DBA with the actual SQL artifacts, and he could review them quickly. We also started a <a href="https://rahulpnath.com/blog/code-review/">code review</a> process and began including the DBA for any changes related to SQL artifacts. This gave even more visibility to the DBA and helped catch issues right at the time of development.</p></li>
<li><p>With automated build/deploy till Test environment in place, we <strong>no longer had to make ad-hoc changes</strong> to the databases, and everything was pushed through the source control as it was faster and more comfortable.</p></li>
</ul>


<p>With this few tweaks we were now in a much better state, and there was a one to one trackability between source code and SQL artifacts. It all lived as part of one package, traceable all the way to the source code commit tag auto-generated by the build system.</p>

<h3>Not Invented Here Syndrome</h3>

<p>With the kind of restrictions you have seen till now, you can guess the approach towards third party services and off-the-shelf products. Most of the things are still done in-house (including trying to replicate a service bus). The problem with this approach is that there is a limit as to which you can go doing that after which you probably lose out on your team or the code takes over you where you just cannot maintain it. When starting out on a new project and when the code base is still small building your own mechanisms might seem to work well. But once past that point, you no longer want to continue down the path but invest in industry proven tools. These include logging servers, service-bus/queues (if you need one), email services (especially if you want to track and do statistics on top of the emails send out).</p>

<p>Biggest challenge introducing this is mostly not cost related (as there are a lot of really affordable services for every business)it&rsquo;s mostly the fear of unknown and lack of interest to venture out into unfamiliar territory. The reasons might vary for you, but try to understand the core reason that is hindering the change.</p>

<blockquote><p><em>One technique that worked to get over the fear of the unknown was to introduce this slowly into the system, one at a time, giving enough time for people to get used to the change.</em></p></blockquote>

<p><a href="https://getseq.net/">Seq</a> was one of the first things that we had proposed and long waiting in the wish list. The team was using <a href="https://serilog.net/">Serilog</a> to log, and all the logs were stored in SQL table making it really hard to query and monitor the logs. The infrastructure team did not want to install Seq as it was all new to them and were not sure about the additional task for managing a Seq instance. So we suggested to them to just have it on the development server and to get familiar with the application first. After a couple of days, the business was seeing a benefit with increased visibility into the logs and infrastructure team was also happy with the increased visibility into the logs. Even before a week, they were happy to install one for the test environment as well. At the time of writing we are looking at getting a Seq instance on the UAT server and soon to have a production instance as well. Getting the interested stakeholders to have a feel of the application and slowly introducing the change is a great way to get buy-in.</p>

<p>Now we are trying to push for a service bus!</p>

<h3>Build Server without NuGet access</h3>

<p>The build server we were using was in-house hosted, and the box that it ran did not have internet access. This meant that you cannot have any external package dependencies that can be pulled at build time. We chose to include the package references along with the source code, which is anyways what <a href="https://rahulpnath.com/blog/checking-in-package-dependencies-into-source-control/">I tend to prefer more</a>. All our third-party libraries were pushed along with the source code repository, so the build machine had all the required dependencies and did not have to have internet connectivity to make a build.</p>

<p>Those are just a subset of the issues that we had to run into and bet you there were so many smaller ones. At times problems are not technical in nature, but more about communication and how effectively you are able to get all the people involved to get along with each other.</p>

<blockquote><p><em>Any journey to advancement is about valuing the people around you, understanding them and taking them along with the change. It&rsquo;s a journey that the team needs to make together and not a solo one.</em></p></blockquote>

<p>Different people have different experiences, pain points, concerns and targets to check off. So as a team you need to understand what works for everyone and come to a collective agreement. Just getting all of the concerned parties into a room and having a healthy discussion (mainly by not being prescriptive but descriptive of the issues that you are facing) solves most of the problems.</p>

<p>Do you work in a similar environment? What challenges do you face at work? Sound off in the comments!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-08-28T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Aug 28<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/security/'>security</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/subresource-integrity-sri/" itemprop="url">Subresource Integrity (SRI)</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><em>This article is part of a series of articles - <a href="/blog/ok-i-have-got-https-what-next/">Ok I have got HTTPS! What Next?</a>. In this post, we explore how to use Subresource Integrity and the issues it solves.</em></p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity">Subresource Integrity (SRI)</a> is a security feature that enables browsers to verify that files they fetch (for example, from a CDN) are delivered without unexpected manipulation. It works by allowing you to provide a cryptographic hash that a fetched file must match.</p>

<p><img src="/images/sri.png" class="center" alt="Subresource integrity" /></p>

<p>Using the integrity attribute on <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">script</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link">link</a> element enables browsers to verify externally linked files before loading them. The integrity attribute takes a base64-encoded hash prefixed the corresponding hash algorithm prefix(at present sha256,sha3384, sha512), as shown in the example below.</p>

<figure class='code'><figcaption><span>Integrity attribute as part of the script tag</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">script</span>
</span><span class='line'>  <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.0/redux.js&quot;</span>
</span><span class='line'>  <span class="nx">integrity</span><span class="o">=</span><span class="s2">&quot;sha256-KLkq+W1kKUA6iR5s5Xa/tdzU0yAmXNu7qIGKR/PBoUE=&quot;</span>
</span><span class='line'>  <span class="nx">crossorigin</span><span class="o">=</span><span class="s2">&quot;anonymous&quot;</span> <span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Generating SRI Hash</h3>

<p>To generate the SRI hash for files that are accessible over a URL, you can use <a href="https://www.srihash.org/">srihash.org</a> or <a href="https://allyoucan.cloud/tools/srigenerator/">srigenerator</a> depending on what hash algorithm version you want. If you&rsquo;re going to generate it on your local files, you can use OpenSSL command-line tool (which should be part of your git bash shell if you are looking around for it, like I did)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl dgst -sha256 -binary FILENAME.js <span class="p">|</span> openssl base64 -A
</span></code></pre></td></tr></table></div></figure>


<h3>Third-Party Libraries</h3>

<p>For third-party libraries (js and CSS) referred via CDN, you can grab the script/link element along with the integrity attribute from the CDN sites. Here is an example below from <a href="https://cdnjs.com/">cdnjs</a>.</p>

<p><img src="/images/sri_redux.png" alt="Generate script tag along with SRI Hash" class="center" /></p>

<p>When referring third party libraries via CDN its <a href="https://www.hanselman.com/blog/CDNsFailButYourScriptsDontHaveToFallbackFromCDNToLocalJQuery.aspx">good to fall back to a local copy</a>. In cases where the CDN is unreachable or the integrity check fails it can fall back to a local copy. I chose to include the integrity attribute on the fallback copy as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;script src=&quot;/javascripts/libs/jquery/jquery-2.0.3.min.js&quot; crossorigin=&quot;anonymous&quot; integrity=&quot;sha256-ruuHogwePywKZ7bI1vHGGs7ScbBLhkNUcSSeRjhSUko=&quot;&gt;\x3C/script&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Application Specific Files</h3>

<p>For application specific javascript files, you need to generate the hash everytime you modify it. You could look at integrating this with your build pipeline to make it seamless. You can use the OpenSSL command line tool as shown above to generate the hash during your application build process.</p>

<h3>Inline JavaScript</h3>

<p><em>The <a href="https://html.spec.whatwg.org/multipage/scripting.html#attr-script-integrity">integrity</a> attribute must not be specified when embedding a module script or when the src attribute is not specified.</em> This means that SRI cannot be used for inline javascript. Even though inline javascript should be avoided, there still are scenarios where you might use that or have dynamically generated javascript. In these cases, we can use <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src">nonce</a> attribute on script tag and whitelist that nonce in the <a href="https://rahulpnath.com/blog/http-content-security-policy-csp/">CSP Headers</a>.</p>

<blockquote><p><strong>nonce-&lt;base64-value></strong> <br/>
<em>A whitelist for specific inline scripts using a cryptographic nonce (number used once). The server must generate a unique nonce value each time it transmits a policy. It is critical to provide an unguessable nonce, as bypassing a resource’s policy is otherwise trivial. See unsafe inline script for example. Specifying nonce makes a modern browser ignore &lsquo;unsafe-inline&rsquo; which could still be set for older browsers without nonce support.</em></p></blockquote>

<p>For the jquery fallback above we need a nonce attribute since this is loaded inline.</p>

<figure class='code'><figcaption><span>Nonce attribute</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">nonce</span><span class="o">=</span><span class="s2">&quot;anF1ZXJ5ZmFsbGJhY2s=&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;script src=&quot;/javascripts/libs/jquery/jquery-2.0.3.min.js&quot; crossorigin=&quot;anonymous&quot; integrity=&quot;sha256-ruuHogwePywKZ7bI1vHGGs7ScbBLhkNUcSSeRjhSUko=&quot;&gt;\x3C/script&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then specify this nonce on the CSP headers for the script-src. The nonce value can be anything that is base64 encoded.</p>

<figure class='code'><figcaption><span>Web.config CSP header</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;add</span>
</span><span class='line'>  <span class="na">name=</span><span class="s">&quot;Content-Security-Policy&quot;</span>
</span><span class='line'>  <span class="na">value=</span><span class="s">&quot;default-src</span> <span class="err">&#39;self&#39;;script-src</span> <span class="err">c.disquscdn.com</span> <span class="err">&#39;self&#39;</span> <span class="err">&#39;</span><span class="na">nonce-anF1ZXJ5ZmFsbGJhY2s=</span><span class="s">&#39; &#39;</span><span class="err">nonce-ZGlzcXVzc2NyaXB0&#39;;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using nonce allows us to get away with having an inline script. However, this should be avoided if possible. As you may have noticed, by having a nonce on the attribute does not validate the script contents of the associated tag. It executes anything that is within that tag. So if you have dynamic content within the script block, this can be used to your disadvantage by attackers. So use it only if it&rsquo;s absolutely necessary. However, having the nonce attribute for those cases is better so that you can limit inline javascript to those specific script tags.</p>

<h3>Browser Support</h3>

<p><a href="https://caniuse.com/#search=sri">Check if</a> your browser supports Subresource Integrity. Compared to a while back most of the browsers now support SRI.</p>

<p><a href="https://caniuse.com/#search=sri">
  <img src="/images/sri_browser.png" alt="SRI Browser Support" class="center" />
</a></p>

<p>Using SRI, we can make sure that the dependencies that we have are loaded are as expected and not modified in flight or at source by a malicious attacker. There is always a risk that you need to be willing to take when including external dependencies as they could be already having a threat embedded at the time of hash generation. For popular libraries, this is less likely. For those unpopular ones, it&rsquo;s always a good idea to take a quick look at the code to ensure it&rsquo;s not malicious. Using some tools to assist you with this is also a good idea, which we will look into in a separate article.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-08-14T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Aug 14<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/web-api/'>web api</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/enable-cross-origin-requests-cors-in-asp-dot-net-web-api-using-corsoptions/" itemprop="url">Enable Cross-Origin Requests (CORS) in ASP.Net Web API Using CorsOptions</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>I was setting up an API at one of the client&rsquo;s place recently and found that currently, they allow any origin to hit their API by setting the <a href="https://msdn.microsoft.com/en-us/library/dn450212(v=vs.113).aspx">CorsOptions.AllowAll</a> options. In this post, we will look at how to set the CORS options and restrict it to only the domains that you want your API to be accessed from.</p>

<h3>What is Cross-Origin Resource Sharing (CORS)</h3>

<p>Cross-Origin Resource Sharing is a way to relax the browsers <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">Same-Origin Policy</a> whereby to tell a browser to let a web application running at one origin (domain) have permission to access selected resources from a server at a different origin. By specifying the CORS header you instruct the browser to allow all allowed domains to access your resource. Most of the time for the API endpoints you want to be explicit on the hosts that can access your API. By setting CORS, you are only restricting/allowing cross-domain access originating from a browser. <strong>Setting CORS should not be mistaken for a Security feature</strong> whereby you are restricting access from any other sources. Any requests that are formed outside of the browser like using Postman, Fiddler, etc. can still make to your API and you need appropriate authorization/authentication to make sure you are not exposing data to unintended people.</p>

<p><img src="/images/cors.png" alt="Cross-Origin Request" class="center" ></p>

<h3>Enabling in Web API</h3>

<p>In Web API there are multiple ways that you can set CORS.</p>

<ul>
<li><a href="https://www.nuget.org/packages/Microsoft.Owin.Cors/">Microsoft.Owin.Cors</a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Cors">Microsoft.AspNet.WebApi.Cors</a><br/>
<em>This adds <em>System.Web.Http.Cors.dll</em> assembly to your project so can be a bit of confusion if you are looking around for the DLL in the solution</em></li>
</ul>


<p>In the below snippet I am using the <em>Microsoft.Owin.Cors</em> pipeline to setup CORS for the API. The code first reads the application configuration file to get a list of semicolon (;) separated hostnames which are added to the list of allowed origins in the <a href="https://docs.microsoft.com/en-us/previous-versions/aspnet/web-frameworks/dn726408(v=vs.118)">CorsPolicy</a>. By setting the corsOptions with <em>UseCors</em> extension method, the policy gets applied to all the requests coming through the website.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">allowedOriginsConfig</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;origins&quot;</span><span class="p">];</span>
</span><span class='line'><span class="kt">var</span> <span class="n">allowedOrigins</span> <span class="p">=</span> <span class="n">allowedOriginsConfig</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;;&quot;</span> <span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">corsPolicy</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CorsPolicy</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">AllowAnyHeader</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>    <span class="n">AllowAnyMethod</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SupportsCredentials</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">origin</span> <span class="k">in</span> <span class="n">allowedOrigins</span><span class="p">)</span>
</span><span class='line'>    <span class="n">corsPolicy</span><span class="p">.</span><span class="n">Origins</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">policyProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CorsPolicyProvider</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">PolicyResolver</span> <span class="p">=</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="n">corsPolicy</span><span class="p">)</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kt">var</span> <span class="n">corsOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CorsOptions</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">PolicyProvider</span> <span class="p">=</span> <span class="n">policyProvider</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span><span class="p">.</span><span class="n">UseCors</span><span class="p">(</span><span class="n">corsOptions</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Setting Multiple CORS Policy</h3>

<p>If you want to have different CORS policies based on different Controllers/route path, you can use the <em>Map</em> function to set up the CorsOptions for specific route paths. In the below example we apply a different CorsOptions to all routes that match <em>&lsquo;/api/SpecificController&rsquo;</em> and defaults to another for all other requests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">app</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;/api/SpecificController&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">(</span><span class="n">appbuilder</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">appbuilder</span><span class="p">.</span><span class="n">UseCors</span><span class="p">(</span><span class="n">corsOptions2</span><span class="p">));</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">app</span><span class="p">.</span><span class="n">UseCors</span><span class="p">(</span><span class="n">corsOptions1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CORS ≠ Security</h3>

<p>CORS is a way to relax the Cross-Origin Policy and in no way should be seen as a security feature. By setting CORS headers what we are saying is to allow all the additional domains in the headers also to be able to access the resource from a browser environment. However setting this, does not restrict access to your API&rsquo;s from other sources like Postman, Fiddler or from any non-browser environments. Even within browser environments, older versions of Flash allows modifying and spoofing of request headers. Ensure that you are using CORS for the correct reasons and not assume that it is providing you security against unauthorized access.</p>

<p>Hope this allows you to setup CORS on your API&rsquo;s!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-07-24T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jul 24<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/security/'>security</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/http-content-security-policy-csp/" itemprop="url">HTTP Content Security Policy (CSP)</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><em>This article is part of a series of articles - <a href="/blog/ok-i-have-got-https-what-next/">Ok I have got HTTPS! What Next?</a>. In this post, we explore how to use HSTS security header and the issues it solves.</em></p>

<p>Content Security Policy (CSP) is a security response header or a <meta> element that instructs the browser, sources of information that it should trust for our website. A browser that supports CSP&rsquo;s then treats this list specified as a whitelist and only allows resources to be loaded only for those sources. CSP&rsquo;s allow you to specify source locations for a variety of resource types which are referred to as <a href="https://developer.mozilla.org/en-US/docs/Glossary/Fetch_directive">fetch directives</a>(e.g. _script-src, img-src,style-src* etc).</p>

<p><img src="/images/content-security-policy.png" alt="Content Security Policy"  class="center" /></p>

<p>CSP is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross Site Scripting (XSS) and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware.</p>

<figure class='code'><figcaption><span>Example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Content-Security-Policy: default-src &#39;self&#39; *.rahulpnath.com
</span></code></pre></td></tr></table></div></figure>


<h3>Setting CSP Headers</h3>

<p><strong>Web Server Configuration</strong></p>

<p>CSP&rsquo;s can be set via the configuration file of your web server host if you want to specify it as part of the header. In my case I use Azure Web App, so all I need to do is add in a web.config file to my root with the header values. Below is an example which specified CSP headers (including Report Only) and <a href="/blog/http-strict-transport-security-sts-or-hsts/">STS headers</a>.</p>

<figure class='code'><figcaption><span>Web.config Sample</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;system.webServer&gt;</span>
</span><span class='line'>    <span class="nt">&lt;httpProtocol&gt;</span>
</span><span class='line'>      <span class="nt">&lt;customHeaders&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Content-Security-Policy&quot;</span> <span class="na">value=</span><span class="s">&quot;upgrade-insecure-requests;&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Content-Security-Policy-Report-Only&quot;</span> <span class="na">value=</span><span class="s">&quot;default-src &#39;none&#39;;report-uri https://rahulpnath.report-uri.com/r/d/csp/reportOnly&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;Strict-Transport-Security&quot;</span> <span class="na">value=</span><span class="s">&quot;max-age=31536000; includeSubDomains; preload&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/customHeaders&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/httpProtocol&gt;</span>
</span><span class='line'>    ...
</span></code></pre></td></tr></table></div></figure>


<p><strong>Using Fiddler</strong></p>

<p>However if all you want is to play around with the CSP header and don&rsquo;t have access to your Web server or the configuration file, you can still test these headers. You can inject in the headers into the response using a <a href="blog/fiddler-free-web-debugging-proxy/">Web Proxy like Fiddler</a></p>

<p>To modify the request/response in-flight you can use one of the most powerful feature in Fiddler - <a href="https://www.telerik.com/blogs/understanding-fiddlerscript">Fiddler Script</a></p>

<blockquote><p>Fiddler Script allows you to enhance Fiddler’s UI, add new features, and modify requests and responses “on the fly” to introduce any behavior you’d like.</p></blockquote>

<p>Using the below script, we can inject &lsquo;Content-Security-Policy&rsquo; header whenever the request matches a specific criteria.</p>

<p><img src="/images/https_csp_fiddler_script.png" alt="Fiddler Script to update CSP"  class="center" /></p>

<figure class='code'><figcaption><span>Fiddler Script - Inject CSP Header</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">oSession</span><span class="p">.</span><span class="nx">HostnameIs</span><span class="p">(</span><span class="s2">&quot;rahulpnath.com&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">oSession</span><span class="p">.</span><span class="nx">oResponse</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">]</span> <span class="o">=</span>
</span><span class='line'>    <span class="s2">&quot;default-src &#39;none&#39;; img-src &#39;self&#39;;script-src &#39;self&#39;;style-src &#39;self&#39;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>By injecting these headers, we can play around with the CSP headers for the webiste without affecting other users. Once you have the CSP rules that cater to your site you can commit this to the actual website. Even with all the CSP headers set, you can additionally set the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-to">report-to</a> (or deprecated <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-uri">report-uri</a>) directive on the policy to capture any policies that you may have missed.</p>

<h3>Content-Security-Policy-Report-Only</h3>

<p>The <em>Content-Security-Policy_Report-Only</em> header allows to test the header settings without any impact and also to capture any CSP headers that you might have missed on your website. The browser uses this for reporting purposes only and does not enforce the policies. We can specify a report endpoint to which the browser will send any CSP violations as a JSON object.</p>

<p>Below is an example of a CSP violation POST request send from the browser to the report URL that I had specified for this blog. I am using an endpoint from the <a href="https://report-uri.com/">Report URI</a> service (more on this later)</p>

<figure class='code'><figcaption><span>Example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">POST</span> <span class="err">https://rahulpnath.report-uri.com/r/d/csp/reportOnly</span> <span class="err">HTTP/</span><span class="mf">1.1</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;csp-report&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;document-uri&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.rahulpnath.com/&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;referrer&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;violated-directive&quot;</span><span class="p">:</span> <span class="s2">&quot;img-src&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;effective-directive&quot;</span><span class="p">:</span> <span class="s2">&quot;img-src&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;original-policy&quot;</span><span class="p">:</span> <span class="s2">&quot;default-src &#39;none&#39;;report-uri https://rahulpnath.report-uri.com/r/d/csp/reportOnly&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;report&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;blocked-uri&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.rahulpnath.com/apple-touch-icon-120x120.png&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;line-number&quot;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;source-file&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.rahulpnath.com/&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;status-code&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;script-sample&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Generating CSP Policies</h3>

<p>Coming up with the CSP policies for your site can be a bit tricky as there are a lot of options and directives involved. Your site might also be pulling in dependencies from a variety of sources. Setting CSP policies is also an excellent time to review your application dependencies and manage them correctly. For e.g., if you have a javascript file from an untrusted source, etc. There are a few ways by which you can go about generating CSP policies. Below are two ways I found useful and easy to get started.</p>

<p><strong>Using Fiddler</strong></p>

<p>The <a href="https://github.com/david-risney/CSP-Fiddler-Extension">CSP Fiddler Extension</a> is a Fiddler extension that helps you produce a strong CSP for a web page (or website). Install the extension and with Fiddler running navigate to your web pages using a browser that supports CSP.</p>

<blockquote><p><em>The extension adds mock Content-Security-Policy-Report-Only headers to servers&#8217; responses and uses the report-uri <a href="https://fiddlercsp.deletethis.net/unsafe-inline.">https://fiddlercsp.deletethis.net/unsafe-inline.</a> The extension then listens to the specified report-uri and generates a CSP based on the gathered information</em></p></blockquote>

<p><img src="/images/https_csp_fiddler_rule_collector.png" class="center" alt="Fiddler CSP Rule Collector" /></p>

<p><strong>Using Report URI</strong></p>

<p><a href="https://report-uri.com/">ReportURI</a> is a real-time security reporting tool which can be used to collect various metrics about your website. One of the features it provides is giving a nice little wizard interface for creating your CSP headers. <a href="https://report-uri.com/#prices">Pricing</a> is usage based and provides the first 10000 reports of the month free (which is what I am using for this blog).</p>

<p>ReportURI gives a dashboard summarizing the various stats of your site and also provides features to explore these in detail.</p>

<p><img src="/images/csp_report_uri_dashboard.png" alt="Report Uri Dashboard" class="center" /></p>

<p>One of the cool features is the <a href="https://scotthelme.co.uk/report-uri-csp-wizard/">CSP Wizard</a> which as the name suggests, provides a wizard-like UI to build out CSP&rsquo;s for the site. The websites need to be configured to report CSP errors to a specific endpoint on your ReportURI endpoint (as shown below). The header value can be set either on CSP header or the Report Only header.</p>

<blockquote><p><em>You can find your report URL from the Setup tab on Report URI. Make sure you use the URL under the options Report Type: CSP and Report Disposition: <strong>Wizard</strong></em></p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Content-Security-Policy-Report-Only: default-src &#39;none&#39;;report-uri https://&lt;subdomain&gt;.report-uri.com/r/d/csp/wizard
</span></code></pre></td></tr></table></div></figure>


<p>Once all configured and reports start coming in you can use the Wizard to pick and choose what sources you need to whitelist for your website. You might see a lot of unwanted sources and entries in the wizard as it just reflects what is reported to it. You need to filter it out manually and build the list.</p>

<p>Once you have the CSP&rsquo;s set you can check out if your site does the Harlem Shake by pressing F12 and running the below script. Though this is not any sort of test, it is a fun exercise to do.</p>

<div class="alert alert-warning">
<b>Copy pasting scripts from unknown source is not at all recommended and is one of the most powerful ways that an attacker can get access to your account.</b> Having a well defined CSP prevents such script attacks as well on your sites. Don&#8217;t be suprised if your banking site also shakes to the tune of the script below. 
</div>


<p><em>That said do give the below script a try! I did go through the code pasted below and it is not malicious. All it does modify your dom elements and plays a music. The original source is available below but I do not control it and it could have change since the time of writing.</em></p>

<figure class='code'><figcaption><span>Harlem Shake - F12 on Browser tab and run below script (Check your Volume)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Source: http://pastebin.com/aJna4paJ</span>
</span><span class='line'><span class="nx">javascript</span><span class="o">:</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="kd">function</span> <span class="nx">c</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">);</span><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;text/css&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">,</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">);</span><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span><span class="nx">f</span><span class="p">);</span><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">l</span><span class="p">);</span>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">e</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">h</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
</span><span class='line'><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">t</span><span class="o">&lt;</span><span class="nx">e</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">t</span><span class="o">++</span><span class="p">){</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">e</span><span class="p">[</span><span class="nx">t</span><span class="p">])}}</span><span class="kd">function</span> <span class="nx">p</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">a</span><span class="p">);</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">e</span><span class="p">)},</span><span class="mi">100</span><span class="p">)}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">d</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="p">{</span><span class="nx">height</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span><span class="nx">width</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">}}</span><span class="kd">function</span> <span class="nx">v</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span><span class="kd">var</span> <span class="nx">s</span><span class="o">=</span><span class="nx">d</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span><span class='line'><span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">height</span><span class="o">&gt;</span><span class="nx">e</span><span class="o">&amp;&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">height</span><span class="o">&lt;</span><span class="nx">n</span><span class="o">&amp;&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">width</span><span class="o">&gt;</span><span class="nx">t</span><span class="o">&amp;&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">width</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">}</span><span class="kd">function</span> <span class="nx">m</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="nx">e</span><span class="p">;</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="o">!!</span><span class="nx">t</span><span class="p">){</span><span class="nx">n</span><span class="o">+=</span><span class="nx">t</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span><span class="nx">t</span><span class="o">=</span><span class="nx">t</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">}</span><span class="k">return</span> <span class="nx">n</span><span class="p">}</span><span class="kd">function</span> <span class="nx">g</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">){</span><span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="o">&amp;&amp;!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">)){</span><span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">}</span><span class="k">return</span> <span class="mi">0</span><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">y</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span><span class="p">){</span><span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span><span class="p">}</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">E</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="nx">m</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span><span class="k">return</span> <span class="nx">t</span><span class="o">&gt;=</span><span class="nx">w</span><span class="o">&amp;&amp;</span><span class="nx">t</span><span class="o">&lt;=</span><span class="nx">b</span><span class="o">+</span><span class="nx">w</span><span class="p">}</span><span class="kd">function</span> <span class="nx">S</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">);</span><span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span><span class="nx">l</span><span class="p">);</span>
</span><span class='line'><span class="nx">e</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="nx">i</span><span class="p">;</span><span class="nx">e</span><span class="p">.</span><span class="nx">loop</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;canplay&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">x</span><span class="p">(</span><span class="nx">k</span><span class="p">)},</span><span class="mi">500</span><span class="p">);</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">N</span><span class="p">();</span><span class="nx">p</span><span class="p">();</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">e</span><span class="o">&lt;</span><span class="nx">O</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">e</span><span class="o">++</span><span class="p">){</span><span class="nx">T</span><span class="p">(</span><span class="nx">O</span><span class="p">[</span><span class="nx">e</span><span class="p">])}},</span><span class="mi">15500</span><span class="p">)},</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'><span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;ended&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">N</span><span class="p">();</span><span class="nx">h</span><span class="p">()},</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'><span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="s2">&quot; &lt;p&gt;If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.&lt;/p&gt; &lt;p&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span><span class="nx">e</span><span class="p">.</span><span class="nx">play</span><span class="p">()}</span><span class="kd">function</span> <span class="nx">x</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">e</span><span class="p">.</span><span class="nx">className</span><span class="o">+=</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">s</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">o</span><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">T</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">e</span><span class="p">.</span><span class="nx">className</span><span class="o">+=</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">s</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">u</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">u</span><span class="p">.</span><span class="nx">length</span><span class="p">)]}</span><span class="kd">function</span> <span class="nx">N</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;\\b&quot;</span><span class="o">+</span><span class="nx">s</span><span class="o">+</span><span class="s2">&quot;\\b&quot;</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">n</span><span class="o">&lt;</span><span class="nx">e</span><span class="p">.</span><span class="nx">length</span><span class="p">;){</span><span class="nx">e</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">className</span><span class="o">=</span><span class="nx">e</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)}}</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="mi">30</span><span class="p">;</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="mi">30</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="mi">350</span><span class="p">;</span><span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="mi">350</span><span class="p">;</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="s2">&quot;//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">s</span><span class="o">=</span><span class="s2">&quot;mw-harlem_shake_me&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="s2">&quot;im_first&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">u</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;im_drunk&quot;</span><span class="p">,</span><span class="s2">&quot;im_baked&quot;</span><span class="p">,</span><span class="s2">&quot;im_trippin&quot;</span><span class="p">,</span><span class="s2">&quot;im_blown&quot;</span><span class="p">];</span><span class="kd">var</span> <span class="nx">a</span><span class="o">=</span><span class="s2">&quot;mw-strobe_light&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">f</span><span class="o">=</span><span class="s2">&quot;//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">l</span><span class="o">=</span><span class="s2">&quot;mw_added_css&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">b</span><span class="o">=</span><span class="nx">g</span><span class="p">();</span><span class="kd">var</span> <span class="nx">w</span><span class="o">=</span><span class="nx">y</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">C</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">k</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">L</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">L</span><span class="o">&lt;</span><span class="nx">C</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">L</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">A</span><span class="o">=</span><span class="nx">C</span><span class="p">[</span><span class="nx">L</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">(</span><span class="nx">A</span><span class="p">)){</span><span class="k">if</span><span class="p">(</span><span class="nx">E</span><span class="p">(</span><span class="nx">A</span><span class="p">)){</span><span class="nx">k</span><span class="o">=</span><span class="nx">A</span><span class="p">;</span><span class="k">break</span><span class="p">}}}</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nx">A</span><span class="o">===</span><span class="kc">null</span><span class="p">){</span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Could not find a node of the right size. Please try a different page.&quot;</span><span class="p">);</span><span class="k">return</span><span class="p">}</span><span class="nx">c</span><span class="p">();</span><span class="nx">S</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">O</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">L</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">L</span><span class="o">&lt;</span><span class="nx">C</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">L</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">A</span><span class="o">=</span><span class="nx">C</span><span class="p">[</span><span class="nx">L</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">(</span><span class="nx">A</span><span class="p">)){</span><span class="nx">O</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">A</span><span class="p">)}}})()</span>
</span></code></pre></td></tr></table></div></figure>


<p>I am still playing around with the CSP headers for this blog and currently testing it out using the ReportOnly header along with ReportURI. Hope this helps you to start putting the correct CSP headers for your site as well!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-07-10T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jul 10<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/security/'>security</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/http-strict-transport-security-sts-or-hsts/" itemprop="url">HTTP Strict Transport Security (STS or HSTS)</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><em>This article is part of a series of articles - <a href="/blog/ok-i-have-got-https-what-next/">Ok I have got HTTPS! What Next?</a>. In this post, we explore how to use HSTS security header and the issues it solves.</em></p>

<p>When you enter a domain name in the browser without specifying the protocol (HTTP or HTTPS) the browser by default sends the first request over HTTP. For a server that supports only HTTPS, when it sees such a request, it redirects the request over to HTTPS. The server responds to the client with a <em>302 Redirect</em>, redirecting the client to HTTPS, from which on the browser starts requesting over HTTPS. As you can see here, the very first request that the client makes is over an insecure channel (HTTP), so is also vulnerable to attacks. You could be prone to man-in-the-middle (MITM) attack, and someone could spoof that request and point you to a different site, inject malicious scripts, etc. <strong>The first insecure HTTP request is made everytime you enter the domain name in the browser or make an explicit call over HTTP.</strong></p>

<p><img src="/images/hsts_tofu.png" alt="Trust on First Use" class="center"></p>

<blockquote><p><em>The HTTP <strong>Strict-Transport-Security</strong> response header (often abbreviated as HSTS) lets a website tell browsers that it should only be accessed using HTTPS, instead of using HTTP</em></p></blockquote>

<p>By using the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security">HTTP Strict Transport Security</a> (HSTS) header on your response headers, you are instructing the browser to make calls over HTTPS instead of HTTP for your site.</p>

<figure class='code'><figcaption><span>Syntax</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Strict-Transport-Security: max-age=&lt;expire-time&gt;
</span><span class='line'>Strict-Transport-Security: max-age=&lt;expire-time&gt;; includeSubDomains
</span><span class='line'>Strict-Transport-Security: max-age=&lt;expire-time&gt;; preload
</span></code></pre></td></tr></table></div></figure>


<p>There are a few directives that you can set on the header which determines how the browser uses the header. By just setting the header with a <em>max-age</em> (required) directive, you tell the browser the <em>time in seconds that the browser should remember that a site is only to be accessed using HTTPS</em>. By default, the setting affects only the current subdomain. Additionally, you can set the <em>includeSubDomains</em> directive to apply this rule to all subdomain of the site. <strong>Before including all subdomains make sure those are served over HTTPS as well so that you do end up blocking your other sites on the same domain (if any).</strong></p>

<p>As you can see with the HSTS header specified, the browser now only makes one insecure request (the one that it makes everytime the cache expires or the very first request). Once it has established a successful connection with the server, all further requests are over HTTPS for the <em>max_age</em> (cache expiry) set. <strong>With the HSTS header the surface area of the attack gets reduced to just one request as compared to all initial requests going over HTTP (when we did not have the HSTS header).</strong></p>

<p>To verify the HSTS header setting has been applied for your website open your browser in Incognito/In-Private browsing mode. It is to make sure that the browser acts as if it is seeing the site for the very first time (as HSTS header caches do not get shared across regular/incognito sessions)</p>

<blockquote><p><em>The HSTS header settings do not get shared across between the regular and incognito browsing session (at least in Chrome and think this is the same for other browsers as well).</em></p></blockquote>

<p>Open the Developer tools window and monitor the Network requests made by the browser. Request your website over HTTP (either explicitly or just entering the domain name) in this case my blog <a href="http://rahulpnath.com">http://rahulpnath.com</a>. As you can see the very first request go over HTTP and the server returns a <em>301 Moved Permanently</em> status with the https version of the site. For any subsequent requests over HTTP, the browser returns a <em>307 Internal Redirect</em>. This redirect happens within the boundary of your browser and redirects to the HTTPS site. You can use <a href="https://rahulpnath.com/blog/fiddler-free-web-debugging-proxy/">Fiddler</a> to verify that this request does not cross the browser boundary. (The request does not get to Fiddler.)</p>

<p><img src="/images/hsts_without_preload.png" alt="HSTS without preload" class ="center" /></p>

<p>We could still argue that there is still a potential threat with the very first request sent over HTTP which is still vulnerable to MITM attack. To solve that we can use the <em>preload</em> directive and submit out domain to an <a href="https://hstspreload.org/">HSTS Preload list</a>, which when successfully added, propagates to the source code of Browsers.</p>

<blockquote><p><em>Most major browsers (Chrome, Firefox, Opera, Safari, IE 11 and Edge) also have HSTS preload lists based on the Chrome list.</em></p></blockquote>

<p>The Browsers hardcode these domains from the preload approved list into their source code (e.g., here is <a href="https://chromium.googlesource.com/chromium/src/net/+/master/http/transport_security_state_static.json">Chrome&rsquo;s list</a>) and gets shipped with their releases. You can check for the preloaded site in the browser as well. Again for chrome navigate to <em>chrome://net-internals/#hsts</em> and query for the HSTS domain.</p>

<p><img src="/images/hsts_preload_static_json.png" alt="HSTS preloaded site hardcoded" class ="center" /></p>

<p>If STS is not set at all or you have not made the very first request to the server (when preload is false) querying for the domain returns &lsquo;Not Found.&rsquo; Below are two variations that you can see depending on whether you have <em>preload</em> set or not. The <em>dynamic_*_*</em> indicates that STS is set after the first load of the site and the <em>static_*_*</em> indicates that it is set from the preload list.</p>

<blockquote><p><em>If you are wondering why this blog does not have _static_*_*</em> set it is because the preload list that it is part of has not yet made into a stable version of Chrome. However, the preload site does show that it is currently preloaded (probably in a beta version at the time of writing)._</p></blockquote>

<p><img src="/images/chrome_hsts_preload.png" alt="Verifying HSTS preload" class ="center" /></p>

<p>With the preload set and your domain hardcoded into the preload list and available as part of the browser version you are on, any request made over HTTP is redirected internally (307) to HTTPS without even going to the server. It means <strong>we have entirely got rid of the first untrusted HTTP request.</strong></p>

<p><img src="/images/hsts_internal_redirect_scott.png" alt="HSTS preload request flow" class ="center" /></p>

<p>Have you already got HSTS set on your site?</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/blog/page/2">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/exclude-certain-scripts-from-transaction-when-using-dbup/">Exclude Certain Scripts From Transaction When Using DbUp</a>
    
    <a class="list-group-item " href="/blog/dot-net-core-api-and-azure-ad-groups-based-access/">.Net Core Web App and Azure AD Groups Role based access</a>
    
    <a class="list-group-item " href="/blog/azure-ad-custom-attributes-and-optional-claims-from-an-asp-dot-net-application/">Azure AD Custom Attributes and Optional Claims from an ASP.Net Application</a>
    
    <a class="list-group-item " href="/blog/setting-up-dbup-in-azure-pipelines/">Setting up DbUp in Azure Pipelines</a>
    
    <a class="list-group-item " href="/blog/azure-pipelines-how-to-find-remaining-build-minutes/">Tip of the Week: Azure Pipelines - How to Find Remaining Free Build Minutes?</a>
    
  </div>
</section>
<section>
    <a href="https://msdn.microsoft.com/en-us/magazine/mt149362?author=Rahul+Nath">
        <img src="/images/msdn_magazine_aside.jpg" alt="MSDN Magazine Author">
    </a>
</section>



<section class="googleplus googleplus-hidden panel panel-default">
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/+RahulNath?rel=author">
        <img src="https://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript" nonce="ZGlzcXVzc2NyaXB0">
      var disqus_shortname = 'rahulpnath';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script nonce="ZmFjZWJvb2tsaWtl">(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript" nonce="dHdlZXRidXR0b24=">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js" 
    integrity="sha256-JMwpUzWY+WKCPEIpvCgEh2RqJ6QqlSV8Md4bmxjzcQ8="
    crossorigin="anonymous">
</script>
<script 
    src="/javascripts/modernizr-2.0.js" 
    integrity="sha256-hME7nDofAgLynuLg6DATEk67QUTY7HetpZJjZ+HNZek="
    crossorigin="anonymous">
</script>

  </body>
</html>
