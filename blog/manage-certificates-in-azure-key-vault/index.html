<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Manage Certificates in Azure Key Vault - Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
<meta name="description" content="Rahul Nath on Programming and life in general" />


<meta name="keywords" content=".NET, programming, rahul nath, rahul, C#, India" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault">
  
<!-- Favicon -->
  <link href="/favicon.png" type="image/png" rel="icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
<!-- End Favicon -->
  <link href="http://feeds2.feedburner.com/rahulpnath" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <!-- Social media content metadata -->


<meta property="fb:admins" content="774780093" />
<meta property="og:title" content="Manage Certificates in Azure Key Vault" />
<meta property="og:site_name" content="Rahul Nath" />
<meta property="og:url" content="http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault/" />
<meta property="og:description" content="Rahul Nath on Programming and life in general" />
<meta property="og:author" content="https://www.facebook.com/774780093" />
<meta property="og:image" content="http://www.rahulpnath.com/images/pfx_security.jpg" />


<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:site" content="rahulpnath" />
<meta property="twitter:url" content="http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault" />
<meta property="twitter:title" content="Manage Certificates in Azure Key Vault" />
<meta property="twitter:description" content="Rahul Nath on Programming and life in general" />
<meta property="twitter:creator" content="rahulpnath" />
<meta property="twitter:image:src" content="http://www.rahulpnath.com/images/pfx_security.jpg" />

<script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43172163-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/apps">Apps</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="http://feeds2.feedburner.com/rahulpnath" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/cse" method="GET">
                    <input type="hidden" name="cx" value="013909293779229500224:v37rx6hsidk" />
                    <input name="ie" type="hidden" value="UTF-8">
                    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="Rahul Nath on Programming and life in general" />
    <meta itemprop="url" content="http://rahulpnath.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-03-01T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Mar 1<sup>st</sup>, 2017</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/azure-key-vault/'>azure key vault</a>
  
</span>


        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Manage Certificates in Azure Key Vault
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p><a href="http://perspecsys.com/" class="center" title="Image By Perspecsys Photos, from https://www.flickr.com/photos/111692634@N04/15855489588"><img class="center" alt="Security" src="/images\pfx_security.jpg" /></a></p>

<p>In one of my earlier posts, <a href="http://www.rahulpnath.com/blog/pfx-certificate-in-azure-key-vault/">PFX Certificate in Azure Key Vault</a>, we saw how to save PFX Certificate files in Key Vault as Secrets. Azure Key Vault now <a href="https://blogs.technet.microsoft.com/kv/2016/09/26/get-started-with-azure-key-vault-certificates/">supports certificates as a first class citizen</a>. This means one can manage certificates as a separate entity in KeyVault. At the time of writing, Key Vault supports managing certificates using Powershell. The <a href="http://www.rahulpnath.com/blog/managing-key-vault-through-azure-portal/">portal UI</a> is still to catch up on this feature. Using the Key Vault&rsquo;s certificate feature, we can create a new certificate: self-signed or signed by a supported certificate authority, import an existing certificate, retrieve the certificate with or without a private key part.</p>

<h3>Setting up the Vault</h3>

<p>With the introduction of the certificates feature, a new command line switch is added to <a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.2.0/set-azurermkeyvaultaccesspolicy">Set-AzureRmKeyVaultAccessPolicy</a> cmdlet <em><a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.2.0/set-azurermkeyvaultaccesspolicy#PermissionsToCertificates">-PermissionToCertificates</a></em>. It supports the following values - <em>all, get, create, delete, import, list, update, deleteissuers, getissuers, listissuers, setissuers, managecontacts</em>. For a key vault created after the introduction of this feature, the property is set to <em>all</em> for the creator&rsquo;s access policy. For any vault created before the introduction of the feature, this property needs to be explicitly set to start using it.</p>

<h3>Create Certificate</h3>

<p>To create a new certificate in the vault use the <a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.2.0/add-azurekeyvaultcertificate">Add-AzureKeyVaultCertificate</a> cmdlet. The cmdlet requires a Certificate Policy that specifies the subject name, issuer name, validity, etc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$certificatepolicy</span> <span class="p">=</span> <span class="nb">New-AzureKeyVaultCertificatePolicy</span>   <span class="n">-SubjectName</span> <span class="s2">&quot;CN=www.rahulpnath.com&quot;</span>   <span class="n">-IssuerName</span> <span class="n">Self</span>   <span class="n">-ValidityInMonths</span> <span class="n">12</span>
</span><span class='line'><span class="nb">Add-AzureKeyVaultCertificate</span> <span class="n">-VaultName</span> <span class="s2">&quot;VaultFromCode&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;TestCertificate&quot;</span> <span class="n">-CertificatePolicy</span> <span class="nv">$certificatepolicy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Executing the above creates a certificate in the vault with the given name. To retrieve the certificates in the key vault use the. The certificate object identifier is similar to that of Keys and Secrets as shown below. This identifier is used to identify a certificate uniquely.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>https://vaultfromcode.vault.azure.net:443/certificates/TestCertificate
</span></code></pre></td></tr></table></div></figure>


<p>To retrieve all the certificates in a vault use the <a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.2.0/get-azurekeyvaultcertificate">Get-AzureKeyVaultCertificate</a> cmdlet passing in the VaultName. To get details of a certificate pass in the Certificate Name as well.</p>

<p><img class="center" alt="Azure Key Vault, GetAzureKeyVaultCertificate" src="/images\keyvault_getazurekeyvaultcertificate.png" /></p>

<p>When creating a new certificate make sure that a Key or Secret does not exist with the same name in the vault. Azure adds in a key and secret with the same name as that of the certificate when creating a new certificate as shown in the above image. The key is required when for certificates created with non-exportable key (-<a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.1.0/new-azurekeyvaultcertificatepolicy#KeyNotExportable">KeyNotExportable</a>). Non-exportable certificates do not have the private portion contained in secret. Any certificate operation requiring the private part should use the key. For consistency, the key exists for exportable certificates as well.</p>

<p>To import an existing certificate into the key vault, we can use <a href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.keyvault/v2.1.0/import-azurekeyvaultcertificate">Import-AzureKeyVaultCertificate</a> cmdlet. The certificate file should be either PFX or PEM format.</p>

<h3>Recreate Certificate Locally from Key Vault</h3>

<p>Often we will have to recreate the certificate on the machine where the application using it is running. To create the private portion of the certificate retrieve it from the Secret, load it into a certificate collection, export and save the file locally.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$kvSecret</span> <span class="p">=</span> <span class="nb">Get-AzureKeyVaultSecret</span> <span class="n">-VaultName</span> <span class="s1">&#39;VaultFromCode&#39;</span> <span class="n">-Name</span> <span class="s1">&#39;TestCertificate&#39;</span>
</span><span class='line'><span class="nv">$kvSecretBytes</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$kvSecret</span><span class="p">.</span><span class="n">SecretValueText</span><span class="p">)</span>
</span><span class='line'><span class="nv">$certCollection</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Certificate2Collection</span>
</span><span class='line'><span class="nv">$certCollection</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="nv">$kvSecretBytes</span><span class="p">,</span><span class="nv">$null</span><span class="p">,</span><span class="no">[System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]</span><span class="p">::</span><span class="n">Exportable</span><span class="p">)</span>
</span><span class='line'><span class="nv">$protectedCertificateBytes</span> <span class="p">=</span> <span class="nv">$certCollection</span><span class="p">.</span><span class="n">Export</span><span class="p">(</span><span class="no">[System.Security.Cryptography.X509Certificates.X509ContentType]</span><span class="p">::</span><span class="n">Pkcs12</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$pfxPath</span> <span class="p">=</span> <span class="s1">&#39;C:\cert\test.pfx&#39;</span>
</span><span class='line'><span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="nv">$pfxPath</span><span class="p">,</span> <span class="nv">$protectedCertificateBytes</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similarly to export the public portion of the certificate</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$cert</span> <span class="p">=</span> <span class="nb">Get-AzureKeyVaultCertificate</span> <span class="n">-VaultName</span> <span class="s1">&#39;VaultFromCode&#39;</span> <span class="n">-Name</span> <span class="s1">&#39;TestCertificate&#39;</span>
</span><span class='line'><span class="nv">$filePath</span> <span class="p">=</span><span class="s1">&#39;C:\cert\TestCertificate.cer&#39;</span>
</span><span class='line'><span class="nv">$certBytes</span> <span class="p">=</span> <span class="nv">$cert</span><span class="p">.</span><span class="n">Certificate</span><span class="p">.</span><span class="n">Export</span><span class="p">(</span><span class="no">[System.Security.Cryptography.X509Certificates.X509ContentType]</span><span class="p">::</span><span class="n">Cert</span><span class="p">)</span>
</span><span class='line'><span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="nv">$filePath</span><span class="p">,</span> <span class="nv">$certBytes</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Delete Certificate</h3>

<p>To delete a certificate use the Remove-AzureKeyVaultCertificate cmdlet and pass in the vault name and certificate name.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nb">Remove-AzureKeyVaultCertificate</span> <span class="n">-VaultName</span> <span class="s1">&#39;VaultFromCode&#39;</span> <span class="n">-Name</span> <span class="s1">&#39;TestCertificate&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hope this helps you to get started with managing certificates in Azure Key Vault.</p>
</div>


      <footer>
        
  


<div>
	<h4>About Rahul</h4>
	<img src="/images/rahul_p_nath.jpeg" style="border:0;vertical-align: baseline;" class="left" alt="Rahul Nath"> 
	<span>
		Rahul Nath is a technology consultant, father, speaker and <del>Microsoft</del> Readify employee. He is a former MCCA and enjoys photography and cycling.
	</span>
	<br />
	<br />
	<a href="https://twitter.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Twitter" src="/images/icon-twitter.png"></a>
	<a href="https://www.facebook.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Facebook" src="/images/icon-fb.png"></a>
	<a href="http://feeds2.feedburner.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Feed" src="/images/icon-rss.png"></a>
</div>
<p style="clear:left;"></p>


        
<div>
<br>
  <h4>You might also like</h4>
  <div class="entry-content">
  <ul>
  
    <li>
    	<p>
      		<a href="/blog/signing-a-pdf-file-using-azure-key-vault/">Signing a PDF File Using Azure Key Vault</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/azure-key-vault-from-node-dot-js/">Azure Key Vault From Node.js</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/azure-key-vault-from-azure-functions-certificate-based-authentication/">Azure Key Vault From Azure Functions - Certificate Based Authentication</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/azure-key-vault-from-azure-functions/">Azure Key Vault From Azure Functions</a>
  		</p>
    </li>
  
  </ul>
</div>
<br>
</div>

        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault/" data-via="rahulpnath" data-counturl="http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/azure-key-vault-talk-at-sydney-alt-dot-net/" title="Previous Post: Azure Key Vault Talk at Sydney Alt.Net">&laquo; Azure Key Vault Talk at Sydney Alt.Net</a></li>
            
            
            <li class="next"><a href="/blog/switching-between-subscriptions-under-same-azure-account-to-access-key-vault/" title="Next Post: Tip of the Week: Switching Subscriptions Under Same Azure Account to Access Key Vaults">Tip of the Week: Switching Subscriptions Under Same Azure Account to Access Key Vaults &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      
    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2017 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'rahulpnath';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault/';
        var disqus_url = 'http://rahulpnath.com/blog/manage-certificates-in-azure-key-vault/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
