<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Signing a PDF File Using Azure Key Vault - Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
<meta name="description" content="Digital sign a PDF using a certificate in Azure Key Vault using iText." />


<meta name="keywords" content=".NET, programming, rahul nath, rahul, C#" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault">
  
<!-- Favicon -->
  <link href="/favicon.png" type="image/png" rel="icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
<!-- End Favicon -->
  <link href="http://feeds2.feedburner.com/rahulpnath" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <!-- Social media content metadata -->


<meta property="fb:admins" content="774780093" />
<meta property="og:title" content="Signing a PDF File Using Azure Key Vault" />
<meta property="og:site_name" content="Rahul Nath" />
<meta property="og:url" content="http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/" />
<meta property="og:description" content="Digital sign a PDF using a certificate in Azure Key Vault using iText." />
<meta property="og:author" content="https://www.facebook.com/774780093" />
<meta property="og:image" content="http://www.rahulpnath.com/images/pdf_signed.png" />


<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:site" content="rahulpnath" />
<meta property="twitter:url" content="http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault" />
<meta property="twitter:title" content="Signing a PDF File Using Azure Key Vault" />
<meta property="twitter:description" content="Digital sign a PDF using a certificate in Azure Key Vault using iText." />
<meta property="twitter:creator" content="rahulpnath" />
<meta property="twitter:image:src" content="http://www.rahulpnath.com/images/pdf_signed.png" />


<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"
    integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU="
    crossorigin="anonymous">
</script>

<script nonce="anF1ZXJ5ZmFsbGJhY2s=">
    window.jQuery || 
    document.write('<script src="/javascripts/libs/jquery/jquery-2.0.3.min.js" crossorigin="anonymous" integrity="sha256-ruuHogwePywKZ7bI1vHGGs7ScbBLhkNUcSSeRjhSUko=">\x3C/script>')
</script>

<link 
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css"
    integrity="sha256-tf1yN1B2PrtzH5Ih5BPn1k1Y1RktwEDkIpLtPczMpzI="
    crossorigin="anonymous" />
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap-theme.min.css"
    integrity="sha256-NLECy3aJQJ/Rw8GArrH9PwuL8LR6slx0xC6v9XTmYak="
    crossorigin="anonymous" />


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43172163-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/apps">Apps</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="http://feeds2.feedburner.com/rahulpnath" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/cse" method="GET">
                    <input type="hidden" name="cx" value="013909293779229500224:v37rx6hsidk" />
                    <input name="ie" type="hidden" value="UTF-8">
                    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />
    <meta itemprop="url" content="http://rahulpnath.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-07-18T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jul 18<sup>th</sup>, 2017</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/azure-key-vault/'>azure key vault</a>
  
</span>


        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Signing a PDF File Using Azure Key Vault
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p><em>How to sign a PDF using Azure Key Vault?</em> - This is one of the questions that I often get regarding Azure Key Vault. In this post, we will explore how to sign a PDF using a certificate in Azure Key Vault. Signing a PDF has various aspects to it which are covered in depth in the white paper - <a href="http://developers.itextpdf.com/books#digsig">Digital Signatures for PDF Documents</a>. We will be using the <a href="http://itextpdf.com/">iText library</a> to sign the PDF. iText is available as a <a href="https://www.nuget.org/packages/itext7/">Nuget package library</a>. The below image shows the elements that composes a digital signature on the left and actual contents on the right.</p>

<p><img src="/images/adobe_signature.png" alt="Digitally Signed PDF Contents" /></p>

<h3>Signing with a Local Certificate</h3>

<p>When the certificate (along with the private key) is available locally, signing the PDF is straightforward. You can load the certificate as an X509Certificate from the local certificate store using the <a href="https://stackoverflow.com/questions/11115511/how-to-find-certificate-by-its-thumbprint-in-c-sharp">thumbprint</a>. Make sure that the certificate is installed with the Exportable option as shown below.</p>

<p><img src="/images/certificate_exportable.png" alt="Exportable certificate" /></p>

<p>The <a href="http://itextsupport.com/apidocs/itext5/latest/com/itextpdf/text/pdf/security/PrivateKeySignature.html">PrivateKeySignature</a> is an implementation of IExteralSignature that can be used to sign the PDF when the private key is available. The below code signs the <em>Hello World.pdf</em> using the certificate from the local store and saves that as <em>Local Key.pdf</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SignPdfWithLocalCertificate</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">certificate</span> <span class="p">=</span> <span class="n">GetCertificateLocal</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">privateKey</span> <span class="p">=</span> <span class="n">DotNetUtilities</span><span class="p">.</span><span class="n">GetKeyPair</span><span class="p">(</span><span class="n">certificate</span><span class="p">.</span><span class="n">PrivateKey</span><span class="p">).</span><span class="n">Private</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">externalSignature</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PrivateKeySignature</span><span class="p">(</span><span class="n">privateKey</span><span class="p">,</span> <span class="s">&quot;SHA-256&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SignPdf</span><span class="p">(</span><span class="n">certificate</span><span class="p">,</span> <span class="n">externalSignature</span><span class="p">,</span> <span class="s">&quot;Local Key.pdf&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SignPdf</span><span class="p">(</span><span class="n">X509Certificate2</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">IExternalSignature</span> <span class="n">externalSignature</span><span class="p">,</span> <span class="kt">string</span> <span class="n">signedPdfName</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">bCert</span> <span class="p">=</span> <span class="n">DotNetUtilities</span><span class="p">.</span><span class="n">FromX509Certificate</span><span class="p">(</span><span class="n">certificate</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">chain</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Org</span><span class="p">.</span><span class="n">BouncyCastle</span><span class="p">.</span><span class="n">X509</span><span class="p">.</span><span class="n">X509Certificate</span><span class="p">[]</span> <span class="p">{</span> <span class="n">bCert</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PdfReader</span><span class="p">(</span><span class="s">&quot;Hello World.pdf&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">signedPdfName</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">OpenOrCreate</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">signer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PdfSigner</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>            <span class="n">signer</span><span class="p">.</span><span class="n">SignDetached</span><span class="p">(</span><span class="n">externalSignature</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">PdfSigner</span><span class="p">.</span><span class="n">CryptoStandard</span><span class="p">.</span><span class="n">CMS</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Certificates in Azure Key Vault</h3>

<p>You can <a href="http://www.rahulpnath.com/blog/manage-certificates-in-azure-key-vault/">manage certificates in Azure Key Vault</a> as a first class citizen. Azure Key Vault supports creating new or uploading existing certificates into the vault. Key Vault provides an option to specify whether the private portion of the certificate is exportable or not. Let us see how we can use the certificate from the vault in both these scenarios.</p>

<h4><strong>Exportable Certificate</strong></h4>

<p>To create a self-signed certificate in the vault use the below PowerShell script. In this case, the private key is exportable. Executing the below script adds a self-signed certificate into the vault.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$certificatepolicy</span> <span class="p">=</span> <span class="nb">New-AzureKeyVaultCertificatePolicy</span>   <span class="n">-SubjectName</span> <span class="s2">&quot;CN=www.rahulpnath.com&quot;</span>   <span class="n">-IssuerName</span> <span class="n">Self</span>   <span class="n">-ValidityInMonths</span> <span class="n">12</span>
</span><span class='line'><span class="nb">Add-AzureKeyVaultCertificate</span> <span class="n">-VaultName</span> <span class="s2">&quot;VaultFromCode&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;TestCertificate&quot;</span> <span class="n">-CertificatePolicy</span> <span class="nv">$certificatepolicy</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/keyvault_getazurekeyvaultcertificate.png" class="center" alt="Key Vault Certificate" /></p>

<p>Creating a certificate, in turn, creates three objects in the vault - Certificate, Key, and Secret. The certificate represents the certificate just created, the Key represents the private part of the certificate, and the Secret has the certificate in PFX format (just as if you had uploaded a <a href="http://www.rahulpnath.com/blog/pfx-certificate-in-azure-key-vault/">PFX as a Secret</a>). Since the certificate created above is exportable, the Secret contains the Private portion of the key as well. To recreate the certificate locally in memory, we use the below code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">X509Certificate2</span><span class="p">&gt;</span> <span class="n">GetCertificateKeyVault</span><span class="p">(</span><span class="kt">string</span> <span class="n">secretIdentifier</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">GetKeyVaultClient</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">GetSecretAsync</span><span class="p">(</span><span class="n">secretIdentifier</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">certSecret</span> <span class="p">=</span> <span class="k">new</span> <span class="n">X509Certificate2</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">secret</span><span class="p">.</span><span class="n">Value</span><span class="p">),</span>
</span><span class='line'>        <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span>
</span><span class='line'>        <span class="n">X509KeyStorageFlags</span><span class="p">.</span><span class="n">Exportable</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">certSecret</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The certificate is encoded as Base64String in the Secret. We create an in-memory representation of the certificate and mark it as <em>Exportable</em>. This certificate can be used the same way as the local certificate. Since the private key is part of it, the PrivateKeySignature can still be used to sign.</p>

<h4><strong>Non Exportable Certificate</strong></h4>

<p>To create a non-exportable certificate when creating the certificate use <a href="https://docs.microsoft.com/en-us/powershell/module/azurerm.keyvault/new-azurekeyvaultcertificatepolicy?view=azurermps-4.1.0"><em>KeyNotExportable</em> flag</a> flag as below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nv">$certificatepolicy</span> <span class="p">=</span> <span class="nb">New-AzureKeyVaultCertificatePolicy</span>   <span class="n">-SubjectName</span> <span class="s2">&quot;CN=www.rahulpnath.com&quot;</span>   <span class="n">-IssuerName</span> <span class="n">Self</span>   <span class="n">-ValidityInMonths</span> <span class="n">12</span> <span class="n">-KeyNotExportable</span>
</span><span class='line'><span class="nb">Add-AzureKeyVaultCertificate</span> <span class="n">-VaultName</span> <span class="s2">&quot;VaultFromCode&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;TestCertificateNE&quot;</span> <span class="n">-CertificatePolicy</span> <span class="nv">$certificatepolicy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Executing this creates three objects in the vault as above. But since we marked the secret as non-exportable, the Secret will not have the private part of the key. We can create an in-memory representation of the certificate, but we cannot use the PrivateKeySignature as the certificate does not have the private key. We need to use the Key created along with the certificate to <em>Sign</em> the PDF bytes. For this we need a custom implementation of <em>IExternalSignature</em> - KeyVaultSignature.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">KeyVaultSignature</span> <span class="p">:</span> <span class="n">IExternalSignature</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">KeyVaultClient</span> <span class="n">keyClient</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="kt">string</span> <span class="n">keyIdentifier</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">KeyVaultSignature</span><span class="p">(</span><span class="n">KeyVaultClient</span> <span class="n">client</span><span class="p">,</span> <span class="kt">string</span> <span class="n">keyIdentifier</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">keyClient</span> <span class="p">=</span> <span class="n">client</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">keyIdentifier</span> <span class="p">=</span> <span class="n">keyIdentifier</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetEncryptionAlgorithm</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;RSA&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetHashAlgorithm</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;SHA-256&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">Sign</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">hasher</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SHA256CryptoServiceProvider</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">digest</span> <span class="p">=</span> <span class="n">hasher</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">keyClient</span>
</span><span class='line'>            <span class="p">.</span><span class="n">SignAsync</span><span class="p">(</span>
</span><span class='line'>                <span class="n">keyIdentifier</span><span class="p">,</span>
</span><span class='line'>                <span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">KeyVault</span><span class="p">.</span><span class="n">WebKey</span><span class="p">.</span><span class="n">JsonWebKeySignatureAlgorithm</span><span class="p">.</span><span class="n">RS256</span><span class="p">,</span>
</span><span class='line'>                <span class="n">digest</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>KeyVaultSignature uses the key vault library to connect to the vault and use the specified key to sign the passed in PDF bytes. Since the key is the private part of the certificate, it will be validated by the public key. Below code shows how to use the KeyVaultSignature in the signing process.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SignPdfWithNonExportableCertificateInKeyVault</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">GetKeyVaultClient</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">exportableSecretIdentifier</span> <span class="p">=</span> <span class="s">&quot;https://vaultfromcode.vault.azure.net:443/secrets/TestCertificateNE&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">certificate</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetCertificateKeyVault</span><span class="p">(</span><span class="n">exportableSecretIdentifier</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">keyIdentifier</span> <span class="p">=</span> <span class="s">&quot;https://vaultfromcode.vault.azure.net:443/keys/TestCertificateNE/65d27605fdf74eb2a3f807827cd756e1&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">externalSignature</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KeyVaultSignature</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">keyIdentifier</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SignPdf</span><span class="p">(</span><span class="n">certificate</span><span class="p">,</span> <span class="n">externalSignature</span><span class="p">,</span> <span class="s">&quot;Non Exportable Key Vault.pdf&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you install and trust the public portion of the certificates, you can see the green tick, indicating that the PDF is verified and signed.</p>

<p><img src="/images/pdf_signed.png" alt="Signed PDF" /></p>

<p>The sample code for all three scenarios is available <a href="https://github.com/rahulpnath/Blog/tree/master/PDFSign">here</a>. I have used ClientId/Secret to authenticate with Key Vault for the sample code. If you are using this in a production environment, I will recommend using <a href="http://www.rahulpnath.com/blog/authenticating-a-client-application-with-azure-key-vault/">certificate to authenticate with Key Vault</a>. iText supports creating PDF stamps and more features in the signing process, which is well documented. Hope this helps you to secure your PDF files.</p>
</div>


      <footer>
        
  


<div>
	<h4>About Rahul</h4>
	<img src="/images/rahul_p_nath.jpeg" style="border:0;vertical-align: baseline;" class="left" alt="Rahul Nath"> 
	<span>
		Rahul Nath is a technology consultant, father, speaker and <del>Microsoft</del> Readify employee. He is a former MCCA and enjoys photography and cycling.
	</span>
	<br />
	<br />
	<a href="https://twitter.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Twitter" src="/images/icon-twitter.png"></a>
	<a href="https://www.facebook.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Facebook" src="/images/icon-fb.png"></a>
	<a href="http://feeds2.feedburner.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Feed" src="/images/icon-rss.png"></a>
</div>
<p style="clear:left;"></p>


        
<div>
<br>
  <h4>You might also like</h4>
  <div class="entry-content">
  <ul>
  
    <li>
    	<p>
      		<a href="/blog/exploring-azurekeyvaultconfigbuilder/">Exploring AzureKeyVaultConfigBuilder</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/azure-key-vault-as-a-connected-service-in-visual-studio-2017/">Azure Key Vault As A Connected Service in Visual Studio 2017</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/authenticating-with-azure-key-vault-using-managed-service-identity/">Authenticating with Azure Key Vault Using Managed Service Identity</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/azure-key-vault-from-node-dot-js/">Azure Key Vault From Node.js</a>
  		</p>
    </li>
  
  </ul>
</div>
<br>
</div>

        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/" data-via="rahulpnath" data-counturl="http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/beyond-compare-compare-files-quick-and-easy/" title="Previous Post: Tip of the Week: Beyond Compare - Compare Files Quick and Easy">&laquo; Tip of the Week: Beyond Compare - Compare Files Quick and Easy</a></li>
            
            
            <li class="next"><a href="/blog/hemingway-editor/" title="Next Post: Tip of the Week: Hemingway Editor - Improve Your Writing">Tip of the Week: Hemingway Editor - Improve Your Writing &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      
    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2019 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript" nonce="ZGlzcXVzc2NyaXB0">
      var disqus_shortname = 'rahulpnath';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/';
        var disqus_url = 'http://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script nonce="ZmFjZWJvb2tsaWtl">(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript" nonce="dHdlZXRidXR0b24=">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js" 
    integrity="sha256-JMwpUzWY+WKCPEIpvCgEh2RqJ6QqlSV8Md4bmxjzcQ8="
    crossorigin="anonymous">
</script>
<script 
    src="/javascripts/modernizr-2.0.js" 
    integrity="sha256-hME7nDofAgLynuLg6DATEk67QUTY7HetpZJjZ+HNZek="
    crossorigin="anonymous">
</script>

  </body>
</html>
