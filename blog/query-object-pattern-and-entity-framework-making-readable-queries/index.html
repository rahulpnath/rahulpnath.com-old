<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Query Object Pattern and Entity Framework - Making Readable Queries - Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
<meta name="description" content="Using a Query Object to contain large query criteria and iterating over the query to make it more readable." />


<meta name="keywords" content=".NET, programming, rahul nath, rahul, C#" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries">
  
<!-- Favicon -->
  <link href="/favicon.png" type="image/png" rel="icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
<!-- End Favicon -->
  <link href="http://feeds2.feedburner.com/rahulpnath" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <!-- Social media content metadata -->


<meta property="fb:admins" content="774780093" />
<meta property="og:title" content="Query Object Pattern and Entity Framework - Making Readable Queries" />
<meta property="og:site_name" content="Rahul Nath" />
<meta property="og:url" content="http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries/" />
<meta property="og:description" content="Using a Query Object to contain large query criteria and iterating over the query to make it more readable." />
<meta property="og:author" content="https://www.facebook.com/774780093" />
<meta property="og:image" content="http://www.rahulpnath.com/images/refactoring.jpg" />


<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:site" content="rahulpnath" />
<meta property="twitter:url" content="http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries" />
<meta property="twitter:title" content="Query Object Pattern and Entity Framework - Making Readable Queries" />
<meta property="twitter:description" content="Using a Query Object to contain large query criteria and iterating over the query to make it more readable." />
<meta property="twitter:creator" content="rahulpnath" />
<meta property="twitter:image:src" content="http://www.rahulpnath.com/images/refactoring.jpg" />


<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"
    integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU="
    crossorigin="anonymous">
</script>

<script nonce="anF1ZXJ5ZmFsbGJhY2s=">
    window.jQuery || 
    document.write('<script src="/javascripts/libs/jquery/jquery-2.0.3.min.js" crossorigin="anonymous" integrity="sha256-ruuHogwePywKZ7bI1vHGGs7ScbBLhkNUcSSeRjhSUko=">\x3C/script>')
</script>

<link 
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css"
    integrity="sha256-tf1yN1B2PrtzH5Ih5BPn1k1Y1RktwEDkIpLtPczMpzI="
    crossorigin="anonymous" />
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap-theme.min.css"
    integrity="sha256-NLECy3aJQJ/Rw8GArrH9PwuL8LR6slx0xC6v9XTmYak="
    crossorigin="anonymous" />


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43172163-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/apps">Apps</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="http://feeds2.feedburner.com/rahulpnath" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/cse" method="GET">
                    <input type="hidden" name="cx" value="013909293779229500224:v37rx6hsidk" />
                    <input name="ie" type="hidden" value="UTF-8">
                    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="Rahul Nath is a programmer, blogger, speaker and enjoys running. Blogs are usually technical or about life in general." />
    <meta itemprop="url" content="http://rahulpnath.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-12-20T00:00:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Dec 20<sup>th</sup>, 2018</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/entity-framework/'>entity framework</a>, <a class='category' href='/blog/category/programming/'>programming</a>
  
</span>


        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Query Object Pattern and Entity Framework - Making Readable Queries
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p>Search is a common requirement for most of the applications that we build today. Searching for data often includes multiple fields, data types, and data from multiple tables (especially when using a relational database). I was recently building a Search page which involved searching for Orders - users needed the ability to search by different criteria such as the employee who created the order, orders for a customer, orders between particular dates, order status, an address of delivery. Order criteria are optional, and they allow to narrow down on your search with additional parameters. We were building an API endpoint to query this data based on the parameters using EF Core backed by Azure SQL.</p>

<p>In this post, we go through the code iterations that I made to improve on the readability of the query and keep it contained in a single place. The intention is to create a Query Object like structure that contains all query logic and keep it centralized and readable.</p>

<blockquote><p><em>A <a href="https://martinfowler.com/eaaCatalog/queryObject.html">Query Object</a> is an interpreter [Gang of Four], that is, a structure of objects that can form itself into a SQL query. You can create this query by referring to classes and fields rather than tables and columns. In this way, those who write the queries can do so independently of the database schema, and changes to the schema can be localized in a single place.</em></p></blockquote>

<figure class='code'><figcaption><span>Query Object capturing the Search Criteria</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSummaryQuery</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int?</span> <span class="n">CustomerId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">DateRange</span> <span class="n">DateRange</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Employee</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Address</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">OrderStatus</span> <span class="n">OrderStatus</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have removed the final projection in all the queries below to keep the code to a minimum. We will go through all the iterations to make the code more readable, keeping the generated SQL query efficient as possible.</p>

<h3>Iteration 1 - Crude Form</h3>

<p>Let&rsquo;s start with the crudest form of the query stating all possible combinations of the query. Since all properties are nullable, check if a value exists before using it in the query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="k">from</span> <span class="n">order</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Order</span>
</span><span class='line'><span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">OrderDelivery</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">OrderId</span>
</span><span class='line'><span class="k">join</span> <span class="n">customer</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Customer</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">CustomerId</span> <span class="k">equals</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
</span><span class='line'><span class="k">where</span> <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">Quote</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>      <span class="n">order</span><span class="p">.</span><span class="n">Active</span> <span class="p">==</span> <span class="k">true</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">Employee</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span>
</span><span class='line'>      <span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">CreatedBy</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">Employee</span> <span class="p">||</span> <span class="n">customer</span><span class="p">.</span><span class="n">Employee</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">Employee</span><span class="p">))</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(!</span><span class="n">query</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">.</span><span class="n">HasValue</span> <span class="p">||</span>
</span><span class='line'>      <span class="n">customer</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">DateRange</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span>
</span><span class='line'>      <span class="n">order</span><span class="p">.</span><span class="n">Created</span> <span class="p">&gt;=</span> <span class="n">query</span><span class="p">.</span><span class="n">DateRange</span><span class="p">.</span><span class="n">StartDate</span> <span class="p">&amp;&amp;</span> <span class="n">order</span><span class="p">.</span><span class="n">Created</span> <span class="p">&lt;=</span> <span class="n">query</span><span class="p">.</span><span class="n">DateRange</span><span class="p">.</span><span class="n">EndDate</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Iteration 2 - Separating into Multiple Lines</h3>

<p>With all those explicit AND (&amp;&amp;) clauses the query is hard to understand and keep up. Splitting them into multiple where clauses make it more cleaner and keep each search criteria independent. The end SQL query that gets generated remains the same in this case.</p>

<blockquote><p><a href="https://rahulpnath.com/blog/left-align-your-code-for-better-readability/">Aesthetics of code</a> is as important as the code you write. Aligning is an important part that contributes to the overall aesthetics of code.</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">from</span> <span class="n">order</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Order</span>
</span><span class='line'><span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">OrderDelivery</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">OrderId</span>
</span><span class='line'><span class="k">join</span> <span class="n">customer</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Customer</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">CustomerId</span> <span class="k">equals</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
</span><span class='line'><span class="k">where</span> <span class="n">order</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">orderStatus</span> <span class="p">&amp;&amp;</span> <span class="n">order</span><span class="p">.</span><span class="n">Active</span> <span class="p">==</span> <span class="k">true</span>
</span><span class='line'><span class="k">where</span> <span class="n">query</span><span class="p">.</span><span class="n">Employee</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span>
</span><span class='line'>      <span class="n">order</span><span class="p">.</span><span class="n">CreatedBy</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">Employee</span> <span class="p">||</span> <span class="n">customer</span><span class="p">.</span><span class="n">Employee</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">Employee</span>
</span><span class='line'><span class="k">where</span> <span class="p">!</span><span class="n">query</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">.</span><span class="n">HasValue</span> <span class="p">||</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">query</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">.</span><span class="n">Value</span>
</span><span class='line'><span class="k">where</span> <span class="n">query</span><span class="p">.</span><span class="n">DateRange</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span>
</span><span class='line'>      <span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">Created</span> <span class="p">&gt;=</span> <span class="n">query</span><span class="p">.</span><span class="n">DateRange</span><span class="p">.</span><span class="n">StartDate</span> <span class="p">&amp;&amp;</span> <span class="n">order</span><span class="p">.</span><span class="n">Created</span> <span class="p">&lt;=</span> <span class="n">query</span><span class="p">.</span><span class="n">DateRange</span><span class="p">.</span><span class="n">EndDate</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Iteration 3 - Refactor to Expressions</h3>

<p>Now that each criterion is independently visible let&rsquo;s make each of the <em>where</em> clause more readable. Refactoring them into C# class functions makes the generated SQL inefficient, as EF cannot transform C# functions into SQL.  Such conditions in a standard C# function gets evaluated on the client site, after retrieving all data from the server. Depending on the size of your data, this is something you need <a href="https://docs.microsoft.com/en-us/ef/core/querying/client-eval#client-evaluation-performance-issues">to be aware of</a>.</p>

<p>However, if you use <a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/expressions-in-linq-to-entities-queries">Expressions</a> those get transformed to evaluate on the server. Since all of the conditions on our where clauses can be represented as an Expression, let&rsquo;s move those to the Query object class as properties returning Expressions. Since we need data from multiple tables, the intermediate projection <em>OrderSummaryQueryResult</em> helps to work with data from the multiple tables. All our expressions take the <em>OrderSummaryQueryResult</em> projection and perform the appropriate conditions on them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSummaryQuery</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">BelongsToUser</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Employee</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span>
</span><span class='line'>                      <span class="n">a</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="n">CreatedBy</span> <span class="p">==</span> <span class="n">Employee</span> <span class="p">||</span> <span class="n">a</span><span class="p">.</span><span class="n">Customer</span><span class="p">.</span><span class="n">Employee</span> <span class="p">==</span> <span class="n">Employee</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">IsActiveOrder</span><span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">ForCustomer</span><span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">InDateRange</span><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>Refactored to use Expressions </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="k">from</span> <span class="n">order</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Order</span>
</span><span class='line'> <span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">OrderDelivery</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">OrderId</span>
</span><span class='line'> <span class="k">join</span> <span class="n">customer</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Customer</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">CustomerId</span> <span class="k">equals</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
</span><span class='line'> <span class="k">select</span> <span class="k">new</span> <span class="nf">OrderSummaryQueryResult</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span> <span class="n">Customer</span> <span class="p">=</span> <span class="n">customer</span><span class="p">,</span> <span class="n">Order</span> <span class="p">=</span>    <span class="n">order</span><span class="p">,</span> <span class="n">OrderDelivery</span> <span class="p">=</span> <span class="n">od</span> <span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">IsActiveOrder</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">BelongsToUser</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">ForCustomer</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">InDateRange</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Generated SQL when order status and employee name is set</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="p">[</span><span class="n">customer</span><span class="p">].[</span><span class="n">Name</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">Customer</span><span class="p">],</span> <span class="p">[</span><span class="k">order</span><span class="p">].[</span><span class="n">OrderNumber</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="nb">Number</span><span class="p">],</span>
</span><span class='line'>       <span class="p">[</span><span class="n">od</span><span class="p">].[</span><span class="n">Address</span><span class="p">],</span> <span class="p">[</span><span class="k">order</span><span class="p">].[</span><span class="n">Created</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">CreatedDate</span><span class="p">]</span>
</span><span class='line'><span class="k">FROM</span> <span class="p">[</span><span class="k">Order</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="k">order</span><span class="p">]</span>
</span><span class='line'><span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">OrderDelivery</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">od</span><span class="p">]</span> <span class="k">ON</span> <span class="p">[</span><span class="k">order</span><span class="p">].[</span><span class="n">Id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">od</span><span class="p">].[</span><span class="n">OrderId</span><span class="p">]</span>
</span><span class='line'><span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">Customer</span><span class="p">]</span> <span class="k">AS</span> <span class="p">[</span><span class="n">customer</span><span class="p">]</span> <span class="k">ON</span> <span class="p">[</span><span class="k">order</span><span class="p">].[</span><span class="n">CustomerId</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">customer</span><span class="p">].[</span><span class="n">Id</span><span class="p">]</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(([</span><span class="k">order</span><span class="p">].[</span><span class="n">Active</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">AND</span> <span class="p">([</span><span class="k">order</span><span class="p">].[</span><span class="n">Status</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">__OrderStatus_0</span><span class="p">))</span> <span class="k">AND</span>
</span><span class='line'>      <span class="p">(([</span><span class="k">order</span><span class="p">].[</span><span class="n">CreatedBy</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">__employee_1</span><span class="p">)</span> <span class="k">OR</span> <span class="p">([</span><span class="n">customer</span><span class="p">].[</span><span class="n">Employee</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">__employee_2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<div class="alert alert-warning">
If you use constructor initialization for intermediate projection, *OrderSummaryQueryResult* the where clauses gets executed on the client side. So use the object initializer syntax to create the intermediate projection.
</div>


<h3>Iteration 4 - Refactoring to Extension method</h3>

<p>After the last iteration, we have a query that is easy to read and understand. We also have all queries consolidated within the query object, and it acts as a one place holding all the queries. However, something still felt not right, and I had a quick chat with my friend <a href="https://twitter.com/zpbappi">Bappi</a>, and we refined it further. The above query has too many where clauses and it was just repeating for each of the filters. To encapsulate this further, I moved all the filter expressions to be returned as an Enumerable and wrote an extension method, <em>ApplyAllFilters</em>, to execute them all.</p>

<figure class='code'><figcaption><span>Expose one property for all the filters   </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderSummaryQuery</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;&gt;</span> <span class="n">AllFilters</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">IsActiveOrderStatus</span><span class="p">;</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">BelongsToUser</span><span class="p">;</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">BelongsToCustomer</span><span class="p">;</span>
</span><span class='line'>            <span class="k">yield</span> <span class="k">return</span> <span class="n">FallsInDateRange</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">BelongsToUser</span><span class="p">...</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">IsActiveOrder</span><span class="p">...</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">ForCustomer</span><span class="p">...</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">OrderSummaryQueryResult</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;</span> <span class="n">InDateRange</span><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Extension Method on IQueryable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ApplyAllFilters</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>        <span class="k">this</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">queryable</span><span class="p">,</span>
</span><span class='line'>        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;&gt;</span> <span class="n">filters</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">filter</span> <span class="k">in</span> <span class="n">filters</span><span class="p">)</span>
</span><span class='line'>            <span class="n">queryable</span> <span class="p">=</span> <span class="n">queryable</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">queryable</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="k">from</span> <span class="n">order</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Order</span>
</span><span class='line'>    <span class="k">join</span> <span class="n">od</span> <span class="k">in</span> <span class="n">orderDeliveries</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="k">equals</span> <span class="n">od</span><span class="p">.</span><span class="n">OrderId</span>
</span><span class='line'>    <span class="k">join</span> <span class="n">customer</span> <span class="k">in</span> <span class="n">_context</span><span class="p">.</span><span class="n">Customer</span> <span class="n">on</span> <span class="n">order</span><span class="p">.</span><span class="n">CustomerId</span> <span class="k">equals</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
</span><span class='line'>    <span class="k">select</span> <span class="k">new</span> <span class="nf">OrderSummaryQueryResult</span><span class="p">()</span> <span class="p">{</span> <span class="n">Customer</span> <span class="p">=</span> <span class="n">customer</span><span class="p">,</span> <span class="n">Order</span> <span class="p">=</span> <span class="n">order</span><span class="p">,</span> <span class="n">OrderDelivery</span> <span class="p">=</span> <span class="n">od</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ApplyAllFilters</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="n">AllFilters</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The search query is much more readable than what we started with in Iteration 1. One thing you should always be careful about with EF is making sure that the generated SQL is optimized and you are across what gets executed on the server and the client. Using a SQL Profiler or <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/logging">configure logging</a> to see the generated SQL. You can also <a href="https://docs.microsoft.com/en-us/ef/core/querying/client-eval#optional-behavior-throw-an-exception-for-client-evaluation">configure to throw an exception</a> (in your development environment) for client evaluation.</p>

<p>Hope this helps to write cleaner and readable queries. Sound off in the comments if you have thoughts on refining this further or of any other patterns that you use.</p>
</div>


      <footer>
        
  


<div>
	<h4>About Rahul</h4>
	<img src="/images/rahul_p_nath.jpeg" style="border:0;vertical-align: baseline;" class="left" alt="Rahul Nath"> 
	<span>
		Rahul Nath is a technology consultant, father, speaker and <del>Microsoft</del> Readify employee. He is a former MCCA and enjoys photography and cycling.
	</span>
	<br />
	<br />
	<a href="https://twitter.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Twitter" src="/images/icon-twitter.png"></a>
	<a href="https://www.facebook.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Facebook" src="/images/icon-fb.png"></a>
	<a href="http://feeds2.feedburner.com/rahulpnath" rel="me"><img style="border:0;vertical-align: baseline;" alt="Feed" src="/images/icon-rss.png"></a>
</div>
<p style="clear:left;"></p>


        
<div>
<br>
  <h4>You might also like</h4>
  <div class="entry-content">
  <ul>
  
    <li>
    	<p>
      		<a href="/blog/exclude-certain-scripts-from-transaction-when-using-dbup/">Exclude Certain Scripts From Transaction When Using DbUp</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/setting-up-dbup-in-azure-pipelines/">Setting up DbUp in Azure Pipelines</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/manage-your-postman-api-specs/">Managing Your Postman API Specs</a>
  		</p>
    </li>
  
    <li>
    	<p>
      		<a href="/blog/ndc-security-2018-overview-and-key-takeaways/">NDC Security 2018 - Overview and Key Takeaways</a>
  		</p>
    </li>
  
  </ul>
</div>
<br>
</div>

        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries/" data-via="rahulpnath" data-counturl="http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/exclude-certain-scripts-from-transaction-when-using-dbup/" title="Previous Post: Exclude Certain Scripts From Transaction When Using DbUp">&laquo; Exclude Certain Scripts From Transaction When Using DbUp</a></li>
            
            
            <li class="next"><a href="/blog/2018-recap/" title="Next Post: 2018: What Went Well, What Didn't and Goals">2018: What Went Well, What Didn't and Goals &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      
    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript" nonce="ZGlzcXVzc2NyaXB0">
      var disqus_shortname = 'rahulpnath';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries/';
        var disqus_url = 'http://rahulpnath.com/blog/query-object-pattern-and-entity-framework-making-readable-queries/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script nonce="ZmFjZWJvb2tsaWtl">(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript" nonce="dHdlZXRidXR0b24=">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js" 
    integrity="sha256-JMwpUzWY+WKCPEIpvCgEh2RqJ6QqlSV8Md4bmxjzcQ8="
    crossorigin="anonymous">
</script>
<script 
    src="/javascripts/modernizr-2.0.js" 
    integrity="sha256-hME7nDofAgLynuLg6DATEk67QUTY7HetpZJjZ+HNZek="
    crossorigin="anonymous">
</script>

  </body>
</html>
