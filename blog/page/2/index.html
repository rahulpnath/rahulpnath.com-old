<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
<meta name="description" content="Rahul Nath on Programming and life in general" />


<meta name="keywords" content=".NET, programming, rahul nath, rahul, C#, India" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rahulpnath.com/blog/page/2">
  
<!-- Favicon -->
  <link href="/favicon.png" type="image/png" rel="icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
<!-- End Favicon -->
  <link href="http://feeds2.feedburner.com/rahulpnath" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <!-- Social media content metadata -->


<meta property="fb:admins" content="774780093" />
<meta property="og:title" content="Rahul Nath" />
<meta property="og:site_name" content="Rahul Nath" />
<meta property="og:url" content="http://rahulpnath.com/blog/page/2/" />
<meta property="og:description" content="Rahul Nath on Programming and life in general" />
<meta property="og:author" content="https://www.facebook.com/774780093" />



<meta property="twitter:card" content="summary" />
<meta property="twitter:site" content="rahulpnath" />
<meta property="twitter:url" content="http://rahulpnath.com/blog/page/2" />
<meta property="twitter:title" content="Rahul Nath" />
<meta property="twitter:description" content="Rahul Nath on Programming and life in general" />
<meta property="twitter:creator" content="rahulpnath" />


<script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43172163-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/apps">Apps</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="http://feeds2.feedburner.com/rahulpnath" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/cse" method="GET">
                    <input type="hidden" name="cx" value="013909293779229500224:v37rx6hsidk" />
                    <input name="ie" type="hidden" value="UTF-8">
                    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="Rahul Nath on Programming and life in general" />
    <meta itemprop="url" content="http://rahulpnath.com" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-07-11T05:45:31+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jul 11<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/dot-net/'>.net</a>, <a class='category' href='/blog/category/programming/'>programming</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/protect-yourself-against-line-ending-issues-when-using-environment-dot-newline-to-split-text/" itemprop="url">Protect Yourself Against Line Ending Issues when Using Environment.Newline to Split Text</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><blockquote><p><em>In computing, a <a href="https://en.wikipedia.org/wiki/Newline">newline</a>, also known as a line ending, end of line (EOL), or line break, is a special character or sequence of characters signifying the end of a line of text and the start of a new line. The actual codes representing a newline vary across operating systems, which can be a problem when exchanging text files between systems with different newline representations.</em></p></blockquote>

<p>I was using a Resource (resx) file to store large text of comma separated values (CSV). This key-value mapping represented the mapping of product codes between an old and new system. In code, I split this whole text using <a href="https://msdn.microsoft.com/en-us/library/system.environment.newline(v=vs.110).aspx">Environment.NewLine</a> and then by comma to generate the map, as shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">AllMappings</span> <span class="p">=</span> <span class="n">Resources</span><span class="p">.</span><span class="n">UsageMap</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="sc">&#39;,&#39;</span> <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ToDictionary</span><span class="p">(</span><span class="n">item</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="n">item</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>It all worked fine on my machine and even on other team members machines. There was no reason to doubt this piece of code, until on the development environment we noticed the mapped value in the destination system always null.</p>

<h3>Analyzing the Issue</h3>

<p>Since in the destination system, all the other values were getting populated as expected, except for this mapping it was easy to narrow down to the class that returned the mapping value, to be the problematic one. Initially, I thought this was an issue with the resource file not getting bundled properly. I used <a href="https://www.jetbrains.com/decompiler/">dotPeek</a> to decompile the application and verified that resource file was getting bundled properly and had exactly the same text (visually) as expected.</p>

<p><img src="/images/newline_dotpeek.png" alt ="Resource file disassembled in dotPeek" /></p>

<p>I copied the resource file text from disassembled code in dotPeek into <a href="http://www.flos-freeware.ch/notepad2.html">Notepad2</a> (configured to show the line endings) and everything started falling into place. The resource text file from the build generated code ended with LF (\n), while the one on our development machines had CRLF (\r\n). All machines, including the build machines are running Windows and the expected value for <a href="https://msdn.microsoft.com/en-us/library/system.environment.newline(v=vs.110).aspx">Environemnt.Newline</a> is CRLF - <strong> A string containing &ldquo;\r\n&rdquo; for non-Unix platforms, or a string containing &ldquo;\n&rdquo; for Unix platforms.</strong></p>

<figure>
<img src="/images/newline_diff.png" alt ="Difference between build generated and development machine resource file" />
<figcaption><em>Difference between build generated and development machine resource file</em></figcaption>
</figure>


<h3>Finding the Root Cause</h3>

<p>We use git for our source control and <a href="https://help.github.com/articles/dealing-with-line-endings/">configured to use &lsquo;auto&rsquo; line endings</a> at the repository level. This ensures that the source code, when checked out, matches the line ending format of the machine. We use <a href="https://www.atlassian.com/software/bamboo">Bamboo</a> on our build servers running Windows. The checked out files on the build server had LF line endings, which in turn gets compiled into the assembly.</p>

<p>The checkout step in Bamboo used the built in git plugin (JGit) and has certain limitations. It&rsquo;s recommended to use native git to use the full git features. JGit also has a known issue with <a href="https://jira.atlassian.com/plugins/servlet/mobile#issue/BAM-9591">line endings on a Windows machine</a> and checks out a file with LF endings. So whenever the source code was checked out, it replaced all line endings in the file with LF before compilation. So the resource file ended up having LF line endings in the assembly, and the code could no longer find Environment.Newline (\r\n) to split.</p>

<h3>Possible Fixes</h3>

<p>Two possible ways to fix this issue is</p>

<ul>
<li>Switch to using native git on the bamboo build process</li>
<li>Use LF to split the text and trim any excess characters. This reduces dependency on line endings variations and settings between different machines only until we are on a different machine which has a different format.</li>
</ul>


<p>I chose to use LF to split the text and trim any additional characters, while also <a href="https://confluence.atlassian.com/bamboo/defining-a-new-executable-capability-289277164.html">updating Bamboo to use native git</a> for checkout.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">AllMappings</span> <span class="p">=</span> <span class="n">Resources</span><span class="p">.</span><span class="n">UsageMap</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot;\n&quot;</span><span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="sc">&#39;,&#39;</span> <span class="p">}))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ToDictionary</span><span class="p">(</span><span class="n">item</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Trim</span><span class="p">().</span><span class="n">ToUpper</span><span class="p">(),</span> <span class="n">item</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Trim</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Protecting Against Line Endings</h3>

<p>The easiest and fastest way that this would have come to my notice was to have a unit test in place. This would ensure that the test fails on the build machine. A test like below will pass on my local but not on the build machine as UsageMap would not return any value for the destination system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Theory]</span>
</span><span class='line'><span class="na">[InlineData(&quot;MovieWeek&quot;, &quot;Weekly-Movie&quot;)]</span>
</span><span class='line'><span class="na">[InlineData(&quot;Dell15&quot;, &quot;Laptop-Group3&quot;)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">SutReturnsExpected</span><span class="p">(</span><span class="kt">string</span> <span class="n">sourceSystemCode</span><span class="p">,</span> <span class="kt">string</span> <span class="n">expected</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsageMap</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">actual</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">GetDestinationCode</span><span class="p">(</span><span class="n">sourceSystemCode</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since there are different systems with different line endings and also applications with different line ending settings and issues of its own, there does not seem to be a &lsquo;one fix for all&rsquo; cases. The best I can think of in these cases is it protect us with such unit tests. It fails fast and brings it immediately to out notice. Have you ever had to deal with an issue with line endings and found better ways to handle them?</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-07-01T00:45:05+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jul 1<sup>st</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/dot-net/'>.net</a>, <a class='category' href='/blog/category/tools/'>tools</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/could-not-load-file-or-assembly-or-one-of-its-dependencies/" itemprop="url">Web Application Occasionally Throwing &#8216;Could not Load File or Assembly or one of its Dependencies&#8217; Exception</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>We were facing a strange &lsquo;could not load DLL issue&rsquo;, when building and running multiple host projects in Visual Studio (VS 2015), side by side. We had 2 host projects - an NServiceBus worker role project (a console application) and a Web application and a few other projects, a couple of which are shared between both the host projects. It often happened in our team, when running the IIS-hosted Web application, it threw the error :</p>

<p> <span style='color:red'><em>Could not load file or assembly &lsquo;Newtonsoft.Json&rsquo; or one of its dependencies. The located assembly&rsquo;s manifest definition does not match the assembly reference. </em></span>.</p>

<p>The bin folder of the Web application did have a Newtonsoft.Json DLL, but of a different version of it than what was specified in the packages.config/csproj file. On a rebuild, the correct DLL version gets placed into the bin folder and everything works fine. Though the exception was observed by most of the team members, it did not happen always, which was surprising</p>

<blockquote><p><em>Knowing what exactly caused the issue, I created a sample project to demonstrate it for this blog post. All screenshots and code samples are of the sample application.</em></p></blockquote>

<h3>Using AsmSpy to find conflicting assemblies</h3>

<p><a href="https://github.com/mikehadlow/AsmSpy">AsmSpy</a> is a command-line tool to view conflicting assembly references in a given folder. This is helpful to find the different assemblies that refer to different versions of the same assembly in the given folder. Using AsmSpy, on the bin folder of the web application, it showed the conflicting  Newtonsoft.Json DLL references by different projects in the solution. There were three different versions of Newtonsoft Nuget package referred in the whole solution. The web project referred to an older version than the shared project and the worker project.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>asmspy WebApplication1\bin\ nonsystem
</span><span class='line'>
</span><span class='line'>Detailing only conflicting assembly references.
</span><span class='line'>Reference: Newtonsoft.Json
</span><span class='line'>   7.0.0.0 by SharedLibrary
</span><span class='line'>   6.0.0.0 by WebApplication1
</span><span class='line'>   4.5.0.0 by WebGrease
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The assembly binding redirects for both the host projects were correct and using the version of the package that it referred to in the packages.config and project (csproj) file.</p>

<h3>Using MsBuild Structured Log to find conflicting writes</h3>

<p>Using the <a href="https://github.com/KirillOsenkov/MSBuildStructuredLog">Msbuild Structured Log Viewer</a> to analyze what was happening with the build, I noticed the below &lsquo;<em>DoubleWrites</em>&rsquo; happening with Newtonsoft DLL. The double writes list shows all the folders from where the DLL was getting written into the bin folder of the project getting building. In the MSBuild Structured log viewer, a DLL pops up only when there are more than one places from where a DLL is getting written, hence the name &lsquo;<em>Double writes</em>. This is a problem as there is a possibility of one write overriding other, depending on the order of writes, causing DLL version conflicts (which is exactly what&rsquo;s happening here).</p>

<p><img src="/images/doubleWrite_msbuildLogViewer.png" alt="Double Write Dll conflict" /></p>

<p>But in this specific case, the log captured above does not show the full problem but hints us of a potential problem. The build capture when building the whole solution (sln) shows that there are 2 writes happening from 2 different Newtonsoft package folders, which shows a potential conflict (<em>as shown above</em>). This does not explain the specific error we are facing with the Web application. Running the tool on just the Web application project (csproj), it does not show any DoubleWrites (<em>as shown below</em>).</p>

<p><img class="left" src="/images/doubleWrite_proj_msbuildLogViewer.png" alt="Double Write Dll conflict" /></p>

<p>This confirms that there is something happening with the Web application bin outputs when we build the worker/shared dependency project.</p>

<h3>Building Web application in Visual Studio</h3>

<p>When building a solution with a Web application project in Visual Studio (VS), I noticed that VS copies all the files from the bin folder of referred projects into the bin of the Web application project. This happens even if you build the shared project alone, as VS notices a change in the files of a dependent project and copies it over. So in this particular case, every time we build the dependent shared project or the worker project (which in turn triggers a build on the shared project), it ended up changing the files in shared projects bin folder, triggering VS to copy it over to the Web application&rsquo;s bin folder. This auto copy happens only for the Web application project and not for the Console/WPF project. (<a href="https://twitter.com/rahulpnath/status/745841691979022336">Yet to find</a> what causes this auto copy on VS build)</p>

<figure>
    <img src="/images/doubleWrite_dll_conflict.jpg" alt="Double Write Dll conflict" />
    <figcaption><em>Bin folder of Web application and Console application after building Shared project</em></figcaption>
</figure>


<p></p>

<p>Since <strong><em><a href="https://msdn.microsoft.com/en-us/library/aa984582(v=vs.71).aspx">CopyLocal</a></em></strong>, by default was true for the shared project, Newtonsoft DLLs were also getting copied into the shared project bin and in turn into Web applications bin (by VS). Since the Web application did not build during the above rebuild, it now has a conflicting DLL version of Newtonsoft in its bin folder, that does not match the assembly version it depends on, hence throws the exception, the next time I load the Web application from IIS.</p>

<p>I confirmed with other team members on the repro steps for this issue</p>

<ul>
<li>Get the latest code and do a full rebuild from VS</li>
<li>Launch Web app works fine</li>
<li>Rebuild just one of the dependent projects that have Newtonsoft DLL dependency (which has CopyLocal set to true)</li>
<li>Launch Web app throws the error!</li>
</ul>


<p>It was a consistent repro with the above steps.</p>

<p>To fix the issue, I can choose either to update the Newtonsoft Package version across all the projects in the solution, or set CopyLocal to false, to prevent the DLL getting copied into the bin folder of the shared project and end up copied to Web application bin. <strong><em>I chose to set CopyLocal to false in this specific case.</em></strong></p>

<h3>The Sample Application</h3>

<p>Now that we know what exactly causes the issue, it is easy to create a <a href="https://github.com/rahulpnath/Blog/tree/master/DoubleWrites">sample application</a> to reproduce this issue.</p>

<ul>
<li>Create a Web application project and add NuGet package reference to older version of Newtonsoft</li>
<li>Create a console application/WPF application with a newer version of Newtonsoft Package.</li>
<li>Create a shared library project with a newer version of Newtonsoft Nuget package. Add this shared project as  a project reference to both Web application and console/WPF application.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">Install-Package</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span> <span class="n">-ProjectName</span> <span class="n">WebApplication1</span> <span class="n">-Version</span> <span class="n">6</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
</span><span class='line'><span class="n">Install-Package</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span> <span class="n">-ProjectName</span> <span class="n">SharedLibrary</span> <span class="n">-Version</span> <span class="n">7</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
</span><span class='line'><span class="n">Install-Package</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span> <span class="n">-ProjectName</span> <span class="n">WpfApplication1</span> <span class="n">-Version</span> <span class="n">8</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Follow the build repro steps above to reproduce the error. Change CopyLocal or update NuGet references and see issue gets resolved.</p>

<p>Hope this helps in case you come across a similar issue!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-06-27T05:07:00+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jun 27<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/blogging/'>blogging</a>, <a class='category' href='/blog/category/thoughts/'>thoughts</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/own-your-urls/" itemprop="url">Own Your URLs; Nothing Else Really Matters</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Over the past couple of years, I have been successful in motivating a couple of my friends to start a blog and I am happy about that. Every time I discuss starting a blog the most common things that come up are what platform to choose, where to host, where to buy the domain, blogging frequency,will anyone even read my posts, what to blog etc.  These were the same questions that I had when I wanted to start a blog and good reasons to procrastinate on for a long time. Over the years having changed the blog platform a couple of times, changing domain name providers, hosting platform, blogging tools here is what I have learned.</p>

<h3>The Golden Rule of Blogging!</h3>

<p>You should have already guessed that from the   post title - The URL where you blog under - Make sure you own it. Buy one of your choices, from any of the <a href="https://www.google.com.au/search?q=buy+domain">domain providers</a> (more on this later) and blog under that. While it&rsquo;s easy to start blogging under popular services like WordPress.com/Blogspot.com, you actually don&rsquo;t own your domain.</p>

<p><a href="https://i.kinja-img.com/gawker-media/image/upload/pgtqyluoyhr1swo4wrmn.jpg">
<img class="center" alt="Own your URL" src="/images/url.jpg" /></a></p>

<p>I have committed this mistake, of blogging under a URL not owned by me, not <a href="rahulpnath.blogspot.com">once</a> but <a href="https://rahulpnath.wordpress.com">twice</a>,and ended up having to edit the posts to redirect here. (I did not want to pay the providers a monthly fee just for the redirect and didn&rsquo;t have many readers). It&rsquo;s not that these external platforms are bad, but you are just throwing away the flexibility to change platforms (without any extra  charge) when you want to. Owning your URLs allows you to change platforms, hosts, URL formats, redirects anything that you want to and I like to have that flexibility.</p>

<h3>The lesser important things</h3>

<p>Other than the URL that you blog on, other things are not that important and here&rsquo;s why I feel that. If you are completely new to terms like domain, website, hosting etc. check out this article on <a href="http://support.hostgator.com/articles/hosting-guide/what-is-the-difference-between-domains-vs-hosting-vs-website"> the difference between all these</a>.</p>

<h4><strong>Where to buy the domain?</strong></h4>

<p>Choose one and move on with it, even if you do not like it you can change your domain provider anytime. You can <a href="http://www.macworld.com/article/1164499/web-apps/how-to-transfer-your-domain-name-between-hosts.html">transfer from one host to another</a> very easily and I have done that. I started off with GoDaddy for the first year as they seemed the cheapest when I started. But at the time of renewal, I learned that it was just for the first year that it was cheap but for renewals, it was costlier. So I moved on to <a href="https://www.namecheap.com/?aff=101935">Namecheap</a>(<em>affiliate</em>) and am with them ever since. Nothing against GoDaddy though, if it works for you get it from there or somewhere - <strong>Get one right now if you don&rsquo;t own a domain!</strong></p>

<h4><strong>Where to host?</strong></h4>

<p>For a website to be accessible to all, it needs to be running somewhere on the internet and accessible to all, and this is what typically a <a href="https://en.wikipedia.org/wiki/Web_hosting_service">hosting service</a> provides. The hosting and domain provider need not be the same entity, so you can get your hosting space anywhere and link it with your domain. Your domain provider will give you some console/website where you can configure this. There are also free hosts like <a href="https://pages.github.com/">Github</a>, <a href="https://www.tumblr.com/">tumblr</a>, <a href="https://support.google.com/blogger/answer/55374?hl=en">Blogger</a> etc., which allows custom domain mapping for free, unlike <a href="https://en.support.wordpress.com/domains/">wordpress.com</a>. Godaddy, Namecheap, Azure, AWS etc are few popular options for hosting, if not Google to find what matches your need. <a href="http://www.webhostingsecretrevealed.net/blog/web-hosting-guides/switching-web-host/">Switching from one web host to another</a> is even easier than transferring domains, so do not spend much time deciding where to host.</p>

<h4><strong>Which blogging platform to choose?</strong></h4>

<p>There are a large number of blogging platforms available today and it is a very difficult choice to decide on one. If all you are planning to put is a blog with static text, then <a href="https://www.staticgen.com/">static site generators</a> are a good choice and it ends up you hosting just plain <a href="https://github.com/rahulpnath/rahulpnath.com/tree/blog">HTML, Javascript, CSS and images</a>, <a href="http://www.rahulpnath.com/blog/static-generator-is-all-a-blog-needs-moving-to-octopress/">like this one</a> (at time of writing). But this does involve some knowledge of development environments and tools, so ignore it if you are not that person. <a href="https://wordpress.org/">WordPress</a> is easy to start with and is famous for its 5-minute installations. Note that this is not the wordpress.com site which is like a hosting service, but this is the WordPress  platform itself which you can host yourself anywhere you choose to, like <a href="http://www.rahulpnath.com/blog/azure-web-sites-moving-wordpress-to-cloud/">I did for some time in Azure</a>. WordPress is just one that is popular, but there are a lot of <a href="https://www.microsoft.com/web/gallery/categories.aspx?category=Blogs">similar platforms that you can choose from</a>.</p>

<blockquote><p><em>When starting to blog, choose a platform that makes writing easy and not have the overhead of using the platform stop you from writing</em></p></blockquote>

<h4><strong>Who will read my blog?</strong></h4>

<p>This one was the biggest stopper for me - Who cares about what I write? Maybe no one does, but now I write for myself, it makes me happy as I like to share information with others. Blogging helps me understand and explore topics more deeply. Finally, it&rsquo;s a reference that I can always go back to when I face something similar. If you have faced a particular scenario (which might be totally weird) then it is very likely that it is going to be experienced by somebody else too. And Google makes finding things easy, and it will be found!</p>

<h4><strong>Frequency and commitment</strong></h4>

<p>I have been irregular with my blogging schedules (<a href="http://www.rahulpnath.com/blog/archives/">until lately</a>) and used to blog just when motivation strikes. But since the start of this year, I am trying to blog on a schedule. Just experimenting with it and seeing how it goes, so far I am really liking it.It has given a different outlook to work and life in general, as it makes me look more closely for opportunities to generate a blog post. But it&rsquo;s fine even without a commitment and blog irregularly unless you have some expectations of your reader base or generate revenue from the blog. But have a place to go and scribble down whenever you feel to and own that place!</p>

<figure>  
    <img alt="Blog frequency as on 26-06-2-16 http://www.rahulpnath.com" src="/images/blog_frequency.png" />
    <figcaption><em>Blog frequency as on June,2016 http://www.rahulpnath.com</em></figcaption>
</figure>


<p></p>

<p>It&rsquo;s a good idea to have a schedule to blog , so that you don&rsquo;t just end up writing one post and forget about your blog forever. <a href="https://blog.codinghorror.com/how-to-achieve-ultimate-blog-success-in-one-easy-step/">Pick a schedule that works for you</a> and try to stick with it.</p>

<h4><strong>No Original Content</strong></h4>

<p>It&rsquo;s fine to blog about things that you have not created yourself, the way you learned things or anything you feel to write about, necessarily not even current at the time of writing. For eg., You might be working on Mainframes system and MainFrame is not current and cutting edge now. But that does not mean you should not be blogging about it. Just like you, there are a lot of mainframe developers and it might just help one of them. So don&rsquo;t bother much about the originality of content, it&rsquo;s your experiences and the way you see it- that&rsquo;s always going to be unique.</p>

<blockquote><p><em>&ldquo;A blog is neither a diary nor a journal. Many people think of blogging in relation to those two things, confessional or practical. It is neither but includes elements of both.&rdquo; - Lemn Sissay</em></p></blockquote>

<p><a href="http://www.rahulpnath.com/blog/get-started-with-your-blog/">Every &lsquo;professional&rsquo; should have a blog</a>, and if you don&rsquo;t yet, now is a good time to start one. Sound off in the comments on what you feel about blogging in general, especially if you bought a domain and set up your blog after reading this. It will prove a point for this post!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-06-19T17:38:37+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jun 19<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/dot-net/'>.net</a>, <a class='category' href='/blog/category/azure/'>azure</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/could-not-load-assembly-msshrtmi-dll/" itemprop="url">Could Not Load Assembly msshrtmi.dll?</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>While migrating a few Azure Cloud Services to Web Jobs, we started facing the error, <span style='color: red;'><em>Could not load assembly &hellip; /msshrtmi.dll</em></span>,for just one of the projects. The error provides the exact path from where it is trying to load the DLL and is the same path from which the process is running. But the location does have the <em>msshrtmi.dll</em>, which for some reason the process is not able to load.</p>

<p><img class="center" src="/images/msshrtmi_load_error.png" alt="msshrtmi dll load error" /></p>

<div class="alert alert-info" role="alert">
<strong>TL;DR</strong> This error occurred due to an attribute - <i>&lt;Prefer32Bit&gt;false&lt;/Prefer32Bit&gt;</i> - in the csproj file, while the referred msshrtmi dll was 32-bit version. This might not be applicable to you, but since it has happened once it&#8217;s very likely to happen again.
</div>


<p>To our surprise, this was happening only with a specific worker, while all others (around 8) were working fine. All of the workers are generated by the same build process on a server. For some reason (I am still investigating into this) the msshrtmi.dll is added as an external reference in the project and referred from there in all the project files. This was done mainly because we had a few external dependencies that were dependent on specific Azure SDK version (2.2). But this explicit reference should not have caused any issues as all, as the other processes were working fine and only a specific one was failing.</p>

<p>One useful tool to help diagnose why the .NET framework cannot locate assemblies is <a href="https://msdn.microsoft.com/en-us/library/e74a18c4(v=vs.110).aspx">Assembly Binding Log Viewer(Fuslogvw.exe)</a>. The viewer displays an entry for each failed assembly bind. For each failure, the viewer describes the application that initiated the bind; the assembly the bind is for, including name, version, culture and public key; and the date and time of the failure.</p>

<blockquote><p><em>Fuslogvw.exe is automatically installed with Visual Studio. To run the tool, use the Developer Command Prompt with administrator credentials.</em></p></blockquote>

<p>Running <em>fuslogvw</em> with the application shows the assembly binding error, double clicking which gives a details error information, as shown below. This error message gives more details and tells us that the assembly platform or ContentType is invalid.</p>

<p><img class="center" src="/images/msshrtmi_fuslogvw.png" alt="LOG: Assembly Name is: msshrtmi, Version=2.2.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35
ERR: Invalid assembly platform or ContentType in file (hr = 0x8007000b).
ERR: Run-from-source setup phase failed with hr = 0x8007000b.
ERR: Failed to complete setup of assembly (hr = 0x8007000b). Probing terminated." /></p>

<p>In the Task Manager, the worker with the assembly loading error (last <em>worker</em> in the image below) shows as a 64-bit process, while the others as 32-bit. Since the referred msshrtmi DLL is 32-bit, it explains why it was unable to find the correct platform matching msshrtmi assembly.</p>

<p><img class="center" src="/images/msshrtmi_task_manager.png" alt="msshrtmi task manager" /></p>

<p><a href="https://msdn.microsoft.com/en-us/library/ms164699(v=vs.110).aspx">CorFlags.exe</a> is used to determine whether an .exe file or .dll file is meant to run only on a specific platform or under WOW64. Running the <em>corflags</em> on all the workers produces the below two results:</p>

<p><mark>corflags Problematic_Worker.exe</mark> <br/>
Version   : v4.0.30319 <br/>
CLR Header: 2.5 <br/>
PE        : PE32 <br/>
CorFlags  : 0x1  <br/>
ILONLY    : 1 <br/>
32BITREQ  : 0 <br/>
<mark>32BITPREF : 0</mark><br/>
Signed    : 0</p>

<p><mark>corflags Worker.exe</mark>    <br/>
Version   : v4.0.30319 <br/>
CLR Header: 2.5 <br/>
PE        : PE32 <br/>
CorFlags  : 0x20003 <br/>
ILONLY    : 1 <br/>
32BITREQ  : 0 <br/>
<mark> 32BITPREF : 1</mark>  <br/>
Signed    : 0</p>

<p>The <em>32BITPREF</em> flag is &lsquo;0&rsquo; for the worker that shows the error, whereas for the rest shows 1. The <a href="https://msdn.microsoft.com/en-us/library/ms164699(v=vs.110).aspx"><em>32BITPREF</em></a> flag indicates that the application runs as a 32 bit process even on 64-bit platforms. This explains why the problematic worker was running as 64-bit process since the flag is turned off.</p>

<blockquote><p><em><a href="http://blogs.microsoft.co.il/sasha/2012/04/04/what-anycpu-really-means-as-of-net-45-and-visual-studio-11/">From .NET 4.5 and Visual Studio 11</a>, the default for most .NET projects is again AnyCPU, but there is more than one meaning to AnyCPU now. There is an additional sub-type of AnyCPU, “Any CPU 32-bit preferred”, which is the new default (overall, there are now five options for the /platform C# compiler switch: x86, Itanium, x64, anycpu, and anycpu32bitpreferred). When using that flavor of AnyCPU, the semantics are the following:</em></p>

<ul>
<li><em>If the process runs on a 32-bit Windows system, it runs as a 32-bit process. IL is compiled to x86 machine code.</em></li>
<li><em>If the process runs on a 64-bit Windows system, it runs as a 32-bit process. IL is compiled to x86 machine code.</em></li>
<li><em>If the process runs on an ARM Windows system, it runs as a 32-bit process. IL is compiled to ARM machine code.</em></li>
</ul>
</blockquote>

<p>All the projects are getting built using the same build scripts, and we are not explicitly turning off/on this compiler option. So the next possible place where any setting for this flag is specified is the <em>csproj</em> file. On the properties of the worker project file (the one that shows error), I see that &lsquo;<em>Prefer 32-bit</em>&rsquo; option is not checked and the csproj file has it explicitly set to false (as shown below). For other projects, this option is checked in Visual Studio and has no entry in the csproj file, which means the flag defaults to true.</p>

<p><img class="center" src="/images/msshrtmi_prefer32bit.png" alt="msshrtmi prefer 32bit csproj" /></p>

<p><strong><em>Deleting the Prefer32Bit attribute from the csproj and building fixed the assembly loading issue of msshrtmi!</em></strong></p>

<p>Though this ended up being a minor fix (in terms of code change), I learned a lot of different tools that can be used to debug assembly loading issues. It was using these right tools that helped me identify this extra attribute on the csproj file and help solve the issue. So the next time you see such an error , either with mssrhtmi or another DLL, hope this helps to find your way through!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-06-14T16:48:25+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jun 14<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/parenting/'>parenting</a>, <a class='category' href='/blog/category/thoughts/'>thoughts</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/life-learnings-after-being-a-parent/" itemprop="url">Life Learnings After Being a Parent</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><blockquote><p><em>His father asked Ethan in a raspy voice, &ldquo;You spend time with your son?&rdquo;</em></p>

<p><em>&ldquo;Much as I can,&rdquo; he’d answered, but his father had caught the lie in his eyes.</em></p>

<p><em>&ldquo;It’ll be your loss, Ethan. Day&rsquo;ll come, when he’s grown and it’s too late, that you&rsquo;d give a kingdom to go back and spend a single hour with your son as a boy. To hold him.Read a book to him. Throw a ball with a person in whose eyes you can do no wrong. He doesn&rsquo;t see your failings yet. He looks at you with pure love and it won&rsquo;t last, so you revel in it while it&rsquo;s here.&rdquo;</em></p>

<p><em>Ethan thinks often of that conversation, mostly when he&rsquo;s lying awake in bed at night and everyone else is asleep, and his life screaming past at the speed of light—the weight of bills and the future and his prior failings and all these moments he&rsquo;s missing—all the lost joy—perched like a boulder on his chest.</em></p>

<p>- <strong> <em><a href="http://amzn.to/1YdxuYm">Pines (The Wayward Pines Trilogy, Book 1)</a></em> </strong></p></blockquote>

<p>Every second that I spent with Gautham is a pure joy and I enjoy it to the most. It&rsquo;s true that I have very less time to spend for myself, but then it also made me realized I have not been using all the time I did have before he was born. I have re-arranged all my schedules so that whenever I am home and he is awake, I do nothing else, but be with him! There has been a lot of learnings and realizations that I have had since the last 20 months.</p>

<p><img class="center" alt="Command Line Application Launcher" src="/images/gautham.jpg" /></p>

<h4><strong>Curiosity is what keeps us going</strong></h4>

<p>Each day is a new day and he learns at least one new thing. Though to us (the &lsquo;grown-ups&rsquo;), it feels that he is doing the same thing over and over again, for him, it&rsquo;s the same thing in a new perspective. He is curious about everything that he sees and happens around. I often felt that my job was boring, mundane and repetitive and often ended up being the same thing every day. But then I understood that it is not about what you do but how you see what you are doing, that matters. Having at least one new thing to learn from whatever you do daily is a good way to stay motivated.</p>

<blockquote><p><em>Always try to understand one level below your current level of abstraction - happiness lies there!</em></p></blockquote>

<h4><strong>Making the Complex Simple</strong></h4>

<p>Often when playing with him I realize how overwhelming things are in the world and all that he is yet to learn. But that&rsquo;s just me putting my perspective through his eyes. For him, it&rsquo;s always &lsquo;try try and try again&rsquo;. He tries the best he can do something now and improve on it over the days or months.</p>

<blockquote><p><em>How do you eat an elephant? One bite at a time.</em></p></blockquote>

<p>I often get overwhelmed when dealing with something new - learning a new language, buying a car or even planning a vacation. There are innumerable options for everything these days and all that information is available at our fingertips. But then the way to approach these is to break it down into smaller chunks of work and target that individually. Just like writing this blog post is overwhelming for me for all the things that I think I need to write, but then I write section by section or even line by line. Forming <a href="http://amzn.to/1toWtyy">habits</a> to break anything <a href="http://amzn.to/1Xg6biH">complex into smaller pieces</a> and tackling that is a good way to approach tasks.</p>

<h4><strong>Learning to Disconnect</strong></h4>

<p>I certainly do not want Gautham to be entertained with a smartphone, iPad or laptop while I get to do something else. Though it is very much plausible, that&rsquo;s just setting him up the wrong path. It&rsquo;s easy for us to get distracted into all these and not do what matters to us the most - just like all of us hooked into the social media.</p>

<blockquote><p><em><a href="https://medium.com/life-learning/how-to-live-a-life-of-balance-and-high-productivity-bd5434a61c79#.26mh9yvec">Social media is best as planned entertainment rather than unplanned distraction.</a></em></p></blockquote>

<p>The more you stay offline from these &lsquo;addictive&rsquo; social networks the less you will feel the need to check it. Like I do not want my kid to be addicted to these, I do not want it to get in the way of me using that time for something more useful. Staying disconnected from the internet and social network is a good way to get a lot of time for yourself.</p>

<h4><strong>Less is More</strong></h4>

<p>Gautham is happy just with a bottle cap, or a small thread of a shirt and can spend a lot of time playing with it. It&rsquo;s not in what you have but how you see things that you have matters. I was always attracted to the latest and coolest gadgets and often bought them too. Happiness then was directly related to the things I had in possession and how current I was. I have learned to get over that minimize my expense to what matters most. Though it&rsquo;s a bit late , the saying &lsquo;<em>Do not save what is left after spending but spend what is left after saving</em>&rsquo;, starts making a lot of sense. The fact that there is someone who is completely dependent on me(/wife) brings in a lot of responsibility to life which was missing earlier and puts savings in front of expenses.</p>

<h4><strong>Time is Valuable</strong></h4>

<p>One of the most precious things that I have is time. I used to while away time earlier but now I have very limited of it for myself that I try to spend it usefully. Having your <a href="http://zenhabits.net/purpose-your-day-most-important-task/">Most Important Task</a> (MIT) defined is important and helps prioritize your tasks for the day. If you feel a lot of time is getting lost, while sitting down to work (on a laptop for me) use monitoring tools like <a href="https://www.rescuetime.com/">Rescue Time</a> to understand your daily habits and improve on it.</p>

<blockquote><p><em><a href="http://quoteinvestigator.com/2013/10/30/inspire-nine/">Someone once asked</a> Somerset Maugham if he wrote on a schedule or only when struck by inspiration. “I write only when inspiration strikes,” he replied. “Fortunately, it strikes every morning at nine o’clock sharp.”</em></p></blockquote>

<p>Habits decide what we do every day so it&rsquo;s very important that we form good ones. Though it takes effort, it is possible to <a href="http://charlesduhigg.com/how-habits-work/">rewire any of your habits</a> just by giving attention to it.</p>

<h4><strong>Learning from Mistakes</strong></h4>

<p>When you try, you fail and you fail again and again until you succeed. When you don&rsquo;t try you fail - you fail to succeed! <a href="http://www.psychologyinaction.org/2012/11/22/infants-learn-to-walk-by-learning-to-fall/">Infants learn to walk by learning to fall</a>. It&rsquo;s easy to get into a comfort zone and stay there be it in your jobs or elsewhere. Intentionally putting yourself into a position to learn and grow is important. I spent a large part of my time at the workplace. So I try to own up a lot more unfamiliar things and get exposed more - It&rsquo;s Ok to fail!</p>

<p>Parenting is hard but it&rsquo;s also real fun. You get to learn a lot yourself while on the journey and <strong><em>they give back the initial years of your life</em></strong>. Let me wrap this up quickly as he is about to wake up and the last thing I want is to have all the keys pulled off my keyboard!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-06-05T06:15:31+00:00"  data-updated="true" itemprop="datePublished dateCreated">Jun 5<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/azure-key-vault/'>azure key vault</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/managing-azure-key-vault-using-azure-resource-manager-arm-templates/" itemprop="url">Managing Azure Key Vault using Azure Resource Manager (ARM) Templates</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Creating and managing Azure Key Vault was mostly supported through PowerShell cmdlets <a href="http://www.rahulpnath.com/blog/getting-started-with-azure-key-vault/">initially</a>, but there are multiple ways of achieving this now - <a href="http://www.rahulpnath.com/blog/managing-azure-key-vault-over-the-rest-api/">REST API</a>, <a href="http://www.rahulpnath.com/blog/how-the-deprecation-of-switch-azuremode-affects-azure-key-vault/">PowerShell</a>, CLI or ARM templates. In this post, we will look into how we can use <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/">Azure Resource Manager</a> (ARM) templates to create and manage a Key Vault.</p>

<h3>Azure Resource Manager and Templates</h3>

<p>Simply put, the <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/">Azure Resource Manager</a>(ARM) allows to group different resources in your solution that form a logical unit and manage them together. It allows to spin up all the resources required for your system and deploy them as and when required. You can achieve this using custom PowerShell scripts or creating a template (in JSON format) - Azure Resource Manager Template.</p>

<blockquote><p><em>Within the ARM template, you define the infrastructure for your app, how to configure that infrastructure, and how to publish your app code to that infrastructure.</em></p></blockquote>

<p>You can <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-manager-export-template/">export a template from existing resources</a> for a starting point and then work off that. But in this post, I will start with an empty template as it helps to understand all the template parts. A template is nothing but a JSON file with a specific <a href="http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#">schema</a>. All templates have the below format where a few of the elements are not mandatory. If you are not familiar with the template format and the different elements that make it, I&rsquo;ll wait while you read more about the <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/#template-format">Template format</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;contentVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="p">},</span>
</span><span class='line'>   <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="p">},</span>
</span><span class='line'>   <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="p">],</span>
</span><span class='line'>   <span class="nt">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Key Vault ARM Template</h3>

<p>The <a href="https://github.com/Azure/azure-resource-manager-schemas/blob/c301d6ed1d8876cad60af1f81d420e9249a80594/schemas/2015-06-01/Microsoft.KeyVault.json">Key Vault schema</a> is authored here and is part of the root schema URL that we had <a href="http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#">seen above</a>. Though it might not be able to fully understand the schema details, it helps to understand at a high level what are the different parameters that are allowed when defining a Key Vault. At present, the schema allows only creating <a href="http://www.rahulpnath.com/blog/moving-sensitive-information-from-configuration-file-to-azure-key-vault/">Secrets</a> within a Key Vault and <a href="http://www.rahulpnath.com/blog/how-the-deprecation-of-switch-azuremode-affects-azure-key-vault/">Keys have to be created separately</a>.</p>

<p>Like we did using the <a href="http://www.rahulpnath.com/blog/managing-azure-key-vault-over-the-rest-api/">REST API</a>, with this ARM template I want to create or update a Key Vault with a specified set of properties (like Vault Name, tenant etc), the access policies to specify the AD objects (applications/users) that have access to the Vault and create a few secrets.</p>

<p>Create a new JSON file with any name you like (<em>azuredeploy.json</em>) and copy the above template structure into it. For the content version, you can use any value that you like for e.g. 1.0.0. Next, we need to define the parameters that we need, that are specific to each Key Vault deployment. Without parameters, we will be always deploying the resources with the same name and properties, so it is a good practice to externalize it and use it as required. <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/#parameters">Parameters</a> have a defined structure and allows to have basic validation for the input values. All parameters that does not have a <em>defaultValue</em> needs to be passed in while using the template.</p>

<h4><strong>Parameters</strong></h4>

<p>Let&rsquo;s see a few of the different parameter types that we use in this template. The <em>keyVaultName</em> parameter is a simple string value and is required to be passed in as it does not have a default value specified, where as the <em>enableVaultForVolumeEncryption</em> is an optional parameter and defaults to false. The parameters <em>accessPolicies</em> and <em>secrets</em> are of type <em>array</em> and takes in any valid JSON array. But in this specific case, I want it to be in a specific format but I am yet not sure if I can specify a format structure for the JSON input. Sound off in the comments if you know of a way.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;parameters&quot;</span><span class="err">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;keyVaultName&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of the Key Vault&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;defaultValue&quot;</span><span class="p">:</span> <span class="s2">&quot;{}&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Access policies object {&quot;</span><span class="err">tenantId</span><span class="s2">&quot;:&quot;&quot;,&quot;</span><span class="err">objectId</span><span class="s2">&quot;:&quot;&quot;,</span>
</span><span class='line'><span class="s2">                    &quot;</span><span class="err">permissions</span><span class="s2">&quot;:{&quot;</span><span class="err">keys</span><span class="s2">&quot;:[&quot;&quot;],&quot;</span><span class="err">secrets</span><span class="s2">&quot;:[&quot;&quot;]}}&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;enableVaultForVolumeEncryption&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;defaultValue&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Specifies if the vault is enabled for volume encryption&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;secrets&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;defaultValue&quot;</span><span class="p">:</span> <span class="s2">&quot;{}&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;all secrets {&quot;</span><span class="err">secretName</span><span class="s2">&quot;:&quot;&quot;,&quot;</span><span class="err">secretValue</span><span class="s2">&quot;:&quot;&quot;}&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="err">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><strong>Resources</strong></h4>

<p>The Resources section of the template defines the resources to be deployed or updated and takes in an array of values. Resource manager supports two modes of deployment - <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-deploy/#incremental-and-complete-deployments">Incremental and Complete deployment</a> - and the way you define the resources here will affect what and how things get deployed. The template supports the use of certain <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/#expressions-and-functions">Expressions and Functions</a>, to enable dynamic creation of values. Expressions are enclosed in square brackets ([]) and can appear anywhere is a JSON string value and evaluated when the template is deployed. To use a literal string that starts with a bracket [, use two brackets [[.</p>

<p>The <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-functions/#parameters">parameter function</a> is used to get the value of a parameter that is passed in. I use this to access the Vault name, accessPolicies and other parameters that we had defined earlier. Since accessPolicies in the template expects an array I pass in the parameter object as is to it.</p>

<p>Secrets are defined as nested resources within the Key Vault and can be defined as a nested property within the Key Vault resource as shown in the <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-manager-template-keyvault/#examples">example here</a>. Since here we are interested in dynamically generating the Secrets based on the array value passed in as <em>secrets</em> parameter, I use the <em><a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-create-multiple/#copy-copyindex-and-length">copy, copyIndex and length function</a></em> to iterate through the array and generate the required template. The <em>copy</em> function iterates and produces the same template structure with different values as specified by the parameter values.</p>

<p>Since the Secret is defined as a separate resource, <em>name</em> property needs to indicate that it is a nested resource, hence we are concatenating the Vault Name with it. Without that I was getting the error :</p>

<p><span style='color: red;'><em>A nested resource type must have an identical number of segments as its resource name. A root resource type must have segment length one greater than its resource name.</em></span>.</p>

<p>The <em><a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-define-dependencies/#dependson">dependsOn</a></em> element specifies that the Secret resource is dependent on the Key Vault resource.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'> <span class="s2">&quot;resources&quot;</span><span class="err">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.KeyVault/vaults&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;keyVaultName&#39;)]&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;accessPolicies&#39;)]&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="err">...</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Microsoft.KeyVault/vaults/secrets&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;[concat(parameters(&#39;keyVaultName&#39;), &#39;/&#39;, parameters(&#39;secrets&#39;)[copyIndex()].secretName)]&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;[parameters(&#39;secrets&#39;)[copyIndex()].secretValue]&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;dependsOn&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s2">&quot;[concat(&#39;Microsoft.KeyVault/vaults/&#39;, parameters(&#39;keyVaultName&#39;))]&quot;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;copy&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;secretsCopy&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="s2">&quot;[length(parameters(&#39;secrets&#39;))]&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Deploying with ARM Templates</h3>

<p>To deploy the ARM template we need to pass in the required parameters and run the template.</p>

<h4><strong>Parameter File</strong></h4>

<p>Parameters can be passed in individually or as a <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-deploy/#parameter-file">Parameter File</a>. Parameter file (<em>azuredeploy.parameters.json</em>) is a JSON file with a specific format. Below is a sample parameter file for our Key Vault ARM template. We can have different such templates for each of our deployment environments with values specific for the environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;contentVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;keyVaultName&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;NewARMVaultP&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;tenantId&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;tenantId&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;TENANT ID&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;objectId&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;AD OBJECT ID&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;permissions&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span>
</span><span class='line'>                        <span class="nt">&quot;secrets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span> <span class="err">...</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;secrets&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="nt">&quot;secretName&quot;</span><span class="p">:</span> <span class="s2">&quot;ConnectionString&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nt">&quot;secretValue&quot;</span><span class="p">:</span> <span class="s2">&quot;SecureString1&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span> <span class="err">...</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4><strong>Deployment</strong></h4>

<p>The ARM template along with the parameter file can be deployed in different ways - <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-template-deploy/">PowerShell, Azure CLI, REST API, Visual Studio or from Azure Portal</a>. Using PowerShell we can deploy as below. The <em><a href="https://msdn.microsoft.com/en-us/library/mt679014.aspx">Test-AzureRmResourceGroupDeployment</a></em> cmdlet tests if the template file and parameter file are in correct format. This is mostly useful when authoring the template. <em><a href="https://msdn.microsoft.com/en-us/library/mt603823.aspx">New-AzureRmResourceGroupDeployment</a></em> deploys using the given template file and parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nb">Test-AzureRmResourceGroupDeployment</span> <span class="n">-ResourceGroupName</span> <span class="n">SharedGroup</span> <span class="n">-TemplateFile</span> <span class="p">.\</span><span class="n">azuredeploy</span><span class="p">.</span><span class="n">json</span>
</span><span class='line'>        <span class="n">-TemplateParameterFile</span> <span class="p">.\</span><span class="n">azuredeploy</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">json</span> <span class="n">-Verbose</span>
</span><span class='line'><span class="nb">New-AzureRmResourceGroupDeployment</span> <span class="n">-ResourceGroupName</span> <span class="n">SharedGroup</span> <span class="n">-TemplateFile</span> <span class="p">.\</span><span class="n">azuredeploy</span><span class="p">.</span><span class="n">json</span>
</span><span class='line'>         <span class="n">-TemplateParameterFile</span> <span class="p">.\</span><span class="n">azuredeploy</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">json</span> <span class="n">-Verbose</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://armviz.io/#">ARM Template Visualizer</a> (ArmViz) is a visual way of editing and managing ARM templates and can be useful when dealing with a large number of resource deployments in a template. Also check out some <a href="https://azure.microsoft.com/en-us/documentation/articles/best-practices-resource-manager-design-templates/">Good practices for designing templates</a>. Most of the template code above is <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-manager-template-keyvault/">based off this example here</a>. <strike>I will try to push this template into the <a href="https://github.com/Azure/azure-quickstart-templates">Azure Quickstart Templates</a> but meanwhile it is <a href="https://github.com/rahulpnath/Blog/tree/master/KeyVault%20ARM%20Template">available here</a>.</strike> The ARM template is available with the <a href="https://azure.microsoft.com/en-us/documentation/templates/201-key-vault-secret-create/">Azure Quickstart Templates</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-05-25T06:23:39+00:00"  data-updated="true" itemprop="datePublished dateCreated">May 25<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/azure-key-vault/'>azure key vault</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/managing-azure-key-vault-over-the-rest-api/" itemprop="url">Managing Azure Key Vault over the REST API</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Creating and managing Azure Key Vault was mostly supported through PowerShell cmdlets <a href="http://www.rahulpnath.com/blog/getting-started-with-azure-key-vault/">initially</a>, but there are multiple ways of achieving this now - REST API, <a href="http://www.rahulpnath.com/blog/how-the-deprecation-of-switch-azuremode-affects-azure-key-vault/">PowerShell</a>, CLI or <a href="http://www.rahulpnath.com/blog/managing-azure-key-vaults-using-azure-resource-manager-arm-templates/">ARM templates</a>. In this post, we will look into how we can use the REST API to create and manage a Key Vault.</p>

<h3>Azure Resource Manager API</h3>

<p>The <a href="https://msdn.microsoft.com/en-AU/library/azure/dn790568.aspx">Azure Resource Manager API</a> provides programmatic access to manage Azure services that support <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/">Resource Manager</a>. Since Key Vault supports Resource Manager, we will be using it. Any requests to the API must be authenticated and can be done using an Azure AD application. Most of the steps to create an AD application are same as we saw when creating an AD application to <a href="http://www.rahulpnath.com/blog/authenticating-a-client-application-with-azure-key-vault/">Authenticate a Client Application with Azure Key Vault</a>. From the &lsquo;<em>permissions to other applications</em>&rsquo; tab in portal (as shown below), we can give the application access to Management API&rsquo;s.</p>

<p>To get the token to access the Management API resource (<em><a href="https://management.azure.com">https://management.azure.com</a> </em>), I use the <a href="https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory">ADAL library</a> with the required data. All the information that needs to be passed to the ADAL library is available under the AD application in the azure portal (as shown below).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">string</span> <span class="n">token</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetAccessToken</span><span class="p">(</span>
</span><span class='line'>                <span class="s">&quot;https://login.microsoftonline.com/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;https://management.azure.com/&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'> <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetAccessToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">authority</span><span class="p">,</span> <span class="kt">string</span> <span class="n">resource</span><span class="p">,</span> <span class="kt">string</span> <span class="n">scope</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">adCredential</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ClientCredential</span><span class="p">(</span><span class="n">APPLICATION_ID</span><span class="p">,</span> <span class="n">APPLICATION_SECRET</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">authenticationContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationContext</span><span class="p">(</span><span class="n">authority</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="n">authenticationContext</span><span class="p">.</span><span class="n">AcquireTokenAsync</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">adCredential</span><span class="p">)).</span><span class="n">AccessToken</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Earlier authentication requests were served from <a href="https://login.windows.net">https://login.windows.net</a> (authority URL) which is <a href="https://blogs.technet.microsoft.com/ad/2015/03/06/simplifying-our-azure-ad-authentication-flows/">now updated</a> to <a href="https://login.microsoftonline.com">https://login.microsoftonline.com</a> .</em></p></blockquote>

<p><img src="/images\service_management_adAccess.png" class="center" alt="AD Application access to Azure Service Management API"></p>

<h3>Key Vault Management Client</h3>

<p>The <a href="https://www.nuget.org/packages/Microsoft.Azure.Management.KeyVault/">Microsoft.Azure.Management.KeyVault</a> NuGet package, provides capabilities to connect to the Management API&rsquo;s and manage the Vaults. With the NuGet reference added I can use the <em><a href="https://github.com/Azure/azure-sdk-for-net/blob/master/src/ResourceManagement/KeyVaultManagement/KeyVaultManagement/Generated/KeyVaultManagementClient.cs">KeyVaultManagementClient</a></em>.</p>

<blockquote><p><em>Much of the SDK code is generated  using <a href="https://github.com/azure/autorest">Autorest</a>, from the REST API&rsquo;s metadata spec&rsquo;s in Swagger format.</em></p></blockquote>

<p>With the Azure Subscription Id and the token from the previous step a TokenCloudCredentials is created that is used to connect the Key Vault Management Client.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">string</span> <span class="n">token</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetAccessToken</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;https://login.microsoftonline.com/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;https://management.azure.com/&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'><span class="kt">var</span> <span class="n">tokenCredentials</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TokenCloudCredentials</span><span class="p">(</span><span class="n">SUBSCRIPTION_ID</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span><span class='line'><span class="kt">var</span> <span class="n">keyVaultManagementClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KeyVaultManagementClient</span><span class="p">(</span><span class="n">tokenCredentials</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Key Vaults exists under a Resource Group and for it to be accessible using the AD application authenticated token, we need to grant permission to the application. Just like we managed <a href="http://www.rahulpnath.com/blog/managing-user-permissions-for-key-vault/">User Permissions for Key Vault</a> we can give the AD application access to the Resource Group. We can do this from the new portal (as shown in the other post) or using the <em>New-AzureRmRoleAssignment</em> PowerShell cmdlet. <em>Get-AzureRmADServicePrincipal</em> is used o get the ObjectId of an existing application passing the application name as SearchString. I have yet not found a better way to find the application ObjectId. Please drop a comment if you know of any.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="nb">Get-AzureRmADServicePrincipal</span>  <span class="n">-SearchString</span> <span class="s1">&#39;AD Application Name&#39;</span>
</span><span class='line'><span class="nb">New-AzureRmRoleAssignment</span> <span class="n">-ObjectId</span> <span class="p">&lt;</span><span class="n">AD</span> <span class="n">Application</span> <span class="n">Object</span> <span class="n">Id</span><span class="p">&gt;</span>
</span><span class='line'>     <span class="n">-RoleDefinitionName</span> <span class="n">Reader</span> <span class="n">-ResourceGroupName</span> <span class="n">SharedGroup</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Creating New Key Vault</h3>

<p>We have all the required permissions setup, to create a key vault using the KeyVaultManagament client library. Using this is straightforward as shown below.
The <em><a href="https://github.com/Azure/azure-content/blob/master/articles/resource-manager-template-keyvault.md#sku">Sku</a></em> is used to specify <a href="https://azure.microsoft.com/en-us/pricing/details/key-vault/">Key vault service tier</a> - &lsquo;Standard&rsquo; or &lsquo;Premium&rsquo;. For HSM backed keys it is Premium. Family on Sku object takes in a hardcoded value of &lsquo;A&rsquo;. <em><a href="https://github.com/Azure/azure-content/blob/master/articles/resource-manager-template-keyvault.md#propertiesaccesspolicies-object">AccessPolicies</a></em> specify the AD object identifier of user or application that can access the vault. In this case, I am adding the current AD application with full (<a href="https://github.com/Azure/azure-content/blob/master/articles/resource-manager-template-keyvault.md#propertiesaccesspoliciespermissions-object"><em>all</em></a>) access to Keys and Secrets. Adding an access policy in same as using the <a href="https://msdn.microsoft.com/en-us/library/mt603625.aspx"><em>Set-AzureRmKeyVaultAccessPolicy</em></a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">VaultCreateOrUpdateParameters</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">Location</span> <span class="p">=</span> <span class="s">&quot;southeast asia&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Properties</span> <span class="p">=</span> <span class="k">new</span> <span class="n">VaultProperties</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Sku</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Sku</span> <span class="p">{</span> <span class="n">Family</span> <span class="p">=</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Standard&quot;</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">TenantId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">TENANT_ID</span><span class="p">),</span>
</span><span class='line'>        <span class="n">AccessPolicies</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AccessPolicyEntry</span><span class="p">&gt;()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">AccessPolicyEntry</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="n">TenantId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">TENANT_ID</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">ObjectId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">AD_OBJECT_ID</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">PermissionsToKeys</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;all&quot;</span> <span class="p">},</span>
</span><span class='line'>                        <span class="n">PermissionsToSecrets</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;all&quot;</span> <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">vaultFromCode</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyVaultManagementClient</span><span class="p">.</span><span class="n">Vaults</span>
</span><span class='line'>        <span class="p">.</span><span class="n">CreateOrUpdateAsync</span><span class="p">(</span><span class="s">&quot;SharedGroup&quot;</span><span class="p">,</span> <span class="s">&quot;VaultFromCode&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Managing Existing Key Vaults</h3>

<p><strong>Update a Key Vault</strong></p>

<p>When updating an existing Key Vault, the full state (<em>VaultCreateOrUpdateParameters</em>) must be passed back and not just the update. To add a new <em>AccessPolicyEntry</em>, the existing policy entry values must also be passed back. In the code below, I get the existing state of the Key Vault using the <em>Get</em> and use the current vault properties to add in the new AccessPolicyEntry.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">keyVault</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">keyVaultManagementClient</span><span class="p">.</span><span class="n">Vaults</span>
</span><span class='line'>   <span class="p">.</span><span class="n">GetAsync</span><span class="p">(</span><span class="s">&quot;SharedGroup&quot;</span><span class="p">,</span> <span class="s">&quot;VaultFromCode&quot;</span><span class="p">)).</span><span class="n">Vault</span><span class="p">;</span>
</span><span class='line'>            <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">VaultCreateOrUpdateParameters</span><span class="p">();</span>
</span><span class='line'>            <span class="n">parameters</span><span class="p">.</span><span class="n">Location</span> <span class="p">=</span> <span class="n">keyVault</span><span class="p">.</span><span class="n">Location</span><span class="p">;</span>
</span><span class='line'>            <span class="n">parameters</span><span class="p">.</span><span class="n">Properties</span> <span class="p">=</span> <span class="n">keyVault</span><span class="p">.</span><span class="n">Properties</span><span class="p">;</span>
</span><span class='line'>            <span class="n">parameters</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">AccessPolicies</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">new</span> <span class="n">AccessPolicyEntry</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>       <span class="n">TenantId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">TENANT_ID</span><span class="p">),</span>
</span><span class='line'>       <span class="n">ObjectId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">&quot;AD Object IDentifier&quot;</span><span class="p">),</span>
</span><span class='line'>       <span class="n">PermissionsToKeys</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;get&quot;</span> <span class="p">},</span>
</span><span class='line'>       <span class="n">PermissionsToSecrets</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;get&quot;</span> <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'><span class="k">await</span> <span class="n">keyVaultManagementClient</span><span class="p">.</span><span class="n">Vaults</span><span class="p">.</span><span class="n">CreateOrUpdateAsync</span><span class="p">(</span><span class="s">&quot;SharedGroup&quot;</span><span class="p">,</span> <span class="s">&quot;VaultFromCode&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Delete a Key Vault</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">await</span> <span class="n">keyVaultManagementClient</span><span class="p">.</span><span class="n">Vaults</span><span class="p">.</span><span class="n">DeleteAsync</span><span class="p">(</span><span class="s">&quot;SharedGroup&quot;</span><span class="p">,</span> <span class="s">&quot;VaultFromCode&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hope this helps you manage Azure Key Vault using the REST API.</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-05-18T12:38:24+00:00"  data-updated="true" itemprop="datePublished dateCreated">May 18<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/programming/'>programming</a>, <a class='category' href='/blog/category/thoughts/'>thoughts</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/make-it-easy-for-the-new-person-joining-your-team-have-a-project-ramp-up-plan/" itemprop="url">Make it Easy for the New Person Joining the Team - Have a Project Ramp up Plan</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Recently I was in a discussion with my friend/colleague on conducting a few ramp up sessions for the new hires in our team. The discussion went as below,</p>

<blockquote><p><em>Me: We should hold a few sessions to make the new guys in team more comfortable</em></p>

<p><em>Friend: It&rsquo;s too early for it. We should let them find their own way and not &lsquo;spoon-feed&rsquo; them with information.</em></p>

<p><em>Me: But we are not &lsquo;spoon-feeding&rsquo; them, we are just making their learning process faster and giving then an overview on how all the technology fits together in our world of things.</em></p>

<p><em>Friend: But &lsquo;I did not have any ramp up when I joined, and I felt it was better to have learned it on my own, though it took a lot more time.</em></p></blockquote>

<p><a href="http://www.mindtickle.com/wp-content/uploads/2014/02/new_employee_orientation_business_strategy_research.png" class="center" title="Image, from http://www.mindtickle.com/wp-content/uploads/2014/02/new_employee_orientation_business_strategy_research.png"><img src="/images\rampup_plan.png" class="center" alt="Rampup Plan"></a></p>

<p>Just like there are company-wide induction/onboarding sessions, I have always felt that project specific onboarding plans are also required and help new hires be part of the team and be more productive with their day-to-day activities faster. As mentioned in this <a href="http://www.fastcompany.com/3029820/work-smart/infographic-the-real-ways-to-hold-on-to-new-hires/3">article</a>, <em>New hires care more about effective job training and clear guidelines, and it&rsquo;s time you provide that for them.</em> It&rsquo;s best to have a plan in place when you have someone new joining your team and you along with the team are the best people to put that plan together.</p>

<h3>Boy Scout Rule</h3>

<p>The Boy Scouts have a <a href="http://programmer.97things.oreilly.com/wiki/index.php/The_Boy_Scout_Rule">rule</a> - <em>&ldquo;Always leave the campground cleaner than you found it.&rdquo;</em>  New hires are like &lsquo;new camp group&rsquo; at a campground, so it&rsquo;s the duty of the &lsquo;existing team&rsquo; there to make it a good experience for them.</p>

<blockquote><p><em>&lsquo;Refactor&rsquo; your experiences to make it better for the next person who is about to take on the same journey</em></p></blockquote>

<p>It&rsquo;s not that my friend was intentionally trying not to pass on any information, but he felt that learning on their own would be better. Even I agree with him that learning on your own is far better than &lsquo;spoon-feeding&rsquo; - but a ramp up plan is not spoon-feeding. A ramp up plan is only to speed up the learning process and to make it more comfortable for someone joining new.</p>

<h3>When to create the plan?</h3>

<p>The need for such a plan is there only when there has been enough progress made on the project, after which there is someone new joining the team. So when a new hire is scheduled to join is a good time to create the &lsquo;draft&rsquo; plan. Once the new hire has gone through it and updated back with his own experiences it could become the first version of the plan, which can then be confidently shared to anyone joining after as it has worked for at least one person.</p>

<h3>What should be there in the plan</h3>

<p><em>It depends!</em></p>

<p>It&rsquo;s totally up to the team to decide what should be there in the plan. Some of the things that I usually have are</p>

<ul>
<li><p><strong>Overview of the project and what problem it is trying to solve</strong></p>

<p>It&rsquo;s really important that everyone on the team knows what the application is trying to solve and have a common goal to work towards. It&rsquo;s not just about the code we write but about the problem we are solving and that needs to be clearly defined. I would record a video, when this is done the first time and share it with anyone joining after that, as most of the core concepts of a project rarely change. There could be a follow-up session post watching the video, to also have a quick walk through and fill any missing gaps.</p></li>
<li><p><strong>Introduction to various technologies used in the project and how everything fits together</strong></p>

<p>Technology changes so fast these days that it is nearly impossible to stay updated with all the available options. So a walk through of the different technologies and pointers to resources that worked for you and the team will be of help. If there are any specific libraries, frameworks getting used, an introduction to those should also help.</p></li>
<li><p><strong>Release cycle and Release management</strong>
Every project has its own model of delivering the end product and everyone on the team should understand this process well. Having a continuous build is becoming more common these days and helps reduce the complexity of release. An end to end walk-through of the deployment process helps understand the application better and provides exposure to all the moving parts in the system.</p></li>
<li><p><strong>Environment/Machine setup</strong>
Software installation is one of the biggest pain when setting up a new machine for a project, especially with having specific versions of the software. Having a documented list of all the project dependencies (hardware and software) makes setting the project environment easy. It&rsquo;s preferable to have these <a href="https://chocolatey.org/">scripted</a>. Have a common place, where you can find links to all the various environments (dev, at,prod etc) and related resources.</p></li>
<li><p><strong>Patterns and Conventions</strong>
Every project has its own conventions and certain core patterns that are followed. It&rsquo;s good to have these patterns available for reference so that it helps understand the code better and helps reduce code-review cycles. Than having one big boring document, what I prefer more is to have multiple blog articles targeting each of those. I try to generalize commonly used patterns in the projects that I have worked on and create blog posts. This also helps generate content for <a href="http://www.rahulpnath.com/blog/get-started-with-your-blog/">your blog</a>.</p></li>
<li><p><strong>Tips &amp; Tricks</strong>
This could range from how to easily navigate the code base, scripts to do some commonly occurring task and general things to keep an eye for.</p></li>
</ul>


<p>These are just some of the things I generally try to include in a ramp up plan but as said it totally depends on the team and the project.</p>

<h3>Sharing the plan</h3>

<p>Depending on the plan, if it has confidential information, you could split this into two (or more) different documents and share it at different phases of onboarding. Once a new hire is confirmed it&rsquo;s good to share the parts which do not have any confidential information. Technology stack, conventions used, machine setup (<a href="https://en.wikipedia.org/wiki/Bring_your_own_device">BYOD</a>) are usually not confidential and can be shared well before actual employment. Once all employment agreements are in place the rest too can be shared. It&rsquo;s also a good idea to have some walk-through of the plan itself to make it easier to follow.</p>

<h3>Iterate and Improve</h3>

<p>Updating back with the experiences of the people using the plan is important to keep it current and valuable. Suggesting improvements and updates should be an item in the plan so that this does not get missed. To make updates manageable, the plan must be accessible to all and preferably version controlled if they are documents.</p>

<p>What are your thoughts on having a ramp up plan?</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-05-12T04:27:36+00:00"  data-updated="true" itemprop="datePublished dateCreated">May 12<sup>th</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/javascript/'>javascript</a>, <a class='category' href='/blog/category/react/'>react</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/reactjs-setting-up-the-environment/" itemprop="url">ReactJS: Setting up the Environment</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><em>This post helps setting up the development environment for React on VS Code using Browserify and Gulp</em></p>

<p>I have been playing around with <a href="https://facebook.github.io/react/">React</a> for the past few days and liking the one way binding and immutability concept that it puts forward. The component-based approach and having all related code in a single place is really interesting. Need to explore more and see how it really turns out building UI&rsquo;s with React.</p>

<p>The openness of the Web makes it really difficult to get started with any development platform on it and is the same with React. There are a lot of options for getting things done and can get <a href="https://en.wikipedia.org/wiki/Decision_fatigue">overwhelming when newly starting out</a>. This post explains &lsquo;one way&rsquo; to set up the development environment when developing an application using the React JavaScript framework. I am using VS Code for some time now and wanted to use the same for React development. Except for setting up VS Code, everything else would still make sense to you if you are using a different editor.</p>

<h3>Package Manager for External Dependencies</h3>

<p>One of the first things we need when starting with a fresh project on React, is the React library itself. I use Node Package Manager(npm) for managing all my code and development dependencies. Use the below commands to set up the <a href="https://docs.npmjs.com/cli/init">npm configuration (<em>package.json</em>) </a> and install the latest version of React library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>npm init
</span><span class='line'>npm i --save react
</span><span class='line'>npm i --save react-dom
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>When installing npm packages use <a href="https://docs.npmjs.com/files/package.json#dependencies">&ndash;save</a> if it needs to be deployed with the application and use <a href="https://docs.npmjs.com/files/package.json#devdependencies">&ndash;save-dev</a> for a package added to support development.</em></p></blockquote>

<h3>Setting up VS Code</h3>

<p>JavaScript development experience is better when you have <em><a href="https://code.visualstudio.com/Docs/languages/javascript">jsconfig.json</a></em> file in your project root. VSCode recommends adding this file through a small light bulb notification on the right side of the status bar (as shown below). With this configuration file, VSCode treats all the <em>js</em> files under the same project context.</p>

<p><img class="center" src= "/images/vscode_jsconfig_balloon.png" alt="Visual Studio code jsconfig balloon notification" /></p>

<p>Intellisense for libraries is available through type definition files, usually available in the <a href="http://definitelytyped.org/">DefinitelyTyped</a> <a href="https://github.com/DefinitelyTyped/DefinitelyTyped">repository</a>. With npm, you can manage these definition files using the <a href="https://github.com/typings/typings">TypeScript Definition Manager (typings)</a> package. To get started install the typings package and support for node packages. Now you can use <a href="https://github.com/typings/typings/blob/master/docs/commands.md">typings</a> to manage all the typescript definitions and use it for getting IntelliSense support. Once you have the correct type definitions installed for the packages you use, VSCode will show IntelliSense as shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>npm i --save-dev typings
</span><span class='line'>typings install --ambient node
</span><span class='line'>typings install --save-dev gulp
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src= "/images/react_vscode_intellisense.png" alt="Visual Studio code Intellisense" /></p>

<h3>Hello World from React</h3>

<p>Now that we have enough to get us started let&rsquo;s write our first react component, which displays a message passed into it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">HelloWorld</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
</span><span class='line'>   <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>       <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>           <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>       <span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">HelloWorld</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s save the above into <em><a href="https://github.com/rahulpnath/Blog/blob/master/React_Template/src/components/helloworld.js">components/helloworld.js</a></em>. To use this component in the application, it needs to be rendered into the HTML page. So let&rsquo;s add a main entry point for the application as below and save it into <em><a href="https://github.com/rahulpnath/Blog/blob/master/React_Template/src/main.js">main.js</a></em>. Notice how the component is referred in here and rendered into the HTML div element <em>app</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">HelloWorld</span> <span class="nx">from</span> <span class="s1">&#39;./components/helloworld&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">HelloWorld</span> <span class="nx">message</span> <span class="o">=</span><span class="s2">&quot;Hello World From React&quot;</span> <span class="o">/&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>For completeness below is how the <em><a href="https://github.com/rahulpnath/Blog/blob/master/React_Template/src/Index.html">Index.html</a></em> looks</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using Browserify for Bundling</h3>

<p>Now that we have all the code needed for rendering the component, let&rsquo;s bundle up all the different JavaScript files together so that we can deploy it as a single file. Since we are using <em>JSX</em> and ES6 features, which not all browsers support, we need to transform it. <a href="https://babeljs.io/">Babel</a> is a JavaScript compiler to get this done and it also has preset specific to <a href="https://babeljs.io/docs/plugins/preset-react/">react</a> and <a href="https://babeljs.io/docs/plugins/preset-es2015/">es2015</a>. <a href="http://browserify.org">Browserify</a> bundles all the JavaScript modules and also enables specifying transforms using the <a href="https://github.com/substack/node-browserify#usage">&ndash;transform (-t)</a> switch, to pass in <a href="https://github.com/babel/babelify">babel</a> along with the presets required.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>browserify -t [babelify --presets [react es2015] ] src\main.js -o dest\main.js -d
</span></code></pre></td></tr></table></div></figure>


<p>If you now manually copy over the HTML file into the <em>dest</em> folder and open it from there you should be seeing the &lsquo;<em>Hello World from React</em>&rsquo; message.</p>

<h3>Automating Build and More</h3>

<p>I definitely did not want to keep running the above command and copy the HTML(/CSS) files, every time I make a change, to see the output - so automating it was very much required. What I would essentially like to have is every time I make a change on any of the files in the project, the build to trigger and output the updated application into the <em>dest</em> folder and automatically refreshing the browser so that I can see the changes (near) real-time. I chose to use <a href="http://gulpjs.com/">Gulp</a> as this is popular and I have had some <a href="http://www.rahulpnath.com/blog/organizing-tests-into-test-suites-for-visual-studio/">experience using it before</a>.</p>

<h4><strong><a href="https://github.com/rahulpnath/Blog/blob/master/React_Template/gulpfile.js">gulpfile.js</a></strong></h4>

<p>To organize all the different path&rsquo;s used in the gulp build file, I have an object, <em>path</em> holding all the properties together, that&rsquo;s used in the <a href="https://github.com/gulpjs/gulp/blob/master/docs/API.md#gulptaskname--deps-fn">gulp tasks</a>. The different tasks that I have defined are to <em>build</em> ( which <em>copyHtmlFiles</em> and builds and transforms <em>js</em> files), <em><a href="https://github.com/adametry/gulp-eslint">lint</a></em>, <em><a href="https://github.com/gulpjs/gulp/blob/master/docs/API.md#gulpwatchglob--opts-tasks-or-gulpwatchglob--opts-cb">watch</a></em>&lsquo;es the source folder for changes and triggers the required build, <em><a href="https://www.npmjs.com/package/gulp-connect">connect</a></em>&rsquo;s a server to host the application and automatically <em>reload</em>&rsquo;s the browser whenever code is changed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">appConfig</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">localBaseUrl</span><span class="o">:</span> <span class="s1">&#39;http://localhost&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">port</span><span class="o">:</span> <span class="mi">8090</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">paths</span> <span class="o">:</span> <span class="nx">path</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;copyHtmlFiles&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">HTML</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">DEST</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">reload</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">browserify</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">MAINJS</span><span class="p">,</span> <span class="p">{</span> <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">babelify</span><span class="p">,</span> <span class="p">{</span> <span class="nx">presets</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;react&#39;</span><span class="p">,</span> <span class="s1">&#39;es2015&#39;</span><span class="p">]</span> <span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">bundle</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">source</span><span class="p">(</span><span class="s1">&#39;main.js&#39;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">DEST</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">reload</span><span class="p">());;</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;copyHtmlFiles&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">JS</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">({</span> <span class="nx">config</span><span class="o">:</span> <span class="s1">&#39;eslint.config.json&#39;</span> <span class="p">}))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">.</span><span class="nx">format</span><span class="p">())</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">HTML</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;copyHtmlFiles&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">JS</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">connect</span><span class="p">.</span><span class="nx">server</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">root</span><span class="o">:</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">livereload</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">port</span><span class="o">:</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">port</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;reload&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">&#39;dist/**/*&#39;</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">reload</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">DEST</span> <span class="o">+</span> <span class="s1">&#39;Index.html&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">open</span><span class="p">({</span><span class="nx">uri</span> <span class="o">:</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">localBaseUrl</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">}));</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="s1">&#39;lint&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the default gulp task running, either using <a href="https://code.visualstudio.com/Docs/editor/tasks">VSCode Task Runner</a> or the <a href="https://github.com/gulpjs/gulp/blob/master/docs/getting-started.md#4-run-gulp">command line</a>, any edits that I make to the code gets build and pushed to the output directory and the browser refreshes to show the latest changes.</p>

<p><img class="center" src= "/images/react_realtime_edits.gif" alt="React real-time browser refresh" /></p>

<p><em>If you find any package details missing see the <a href="https://github.com/rahulpnath/Blog/blob/master/React_Template/package.json">package.json</a> file.</em></p>

<p>You can find the hello world project template <a href="https://github.com/rahulpnath/Blog/tree/master/React_Template">here</a>. The repository size is a bit high as I have <a href="http://www.rahulpnath.com/blog/checking-in-package-dependencies-into-source-control/">included the npm packages</a> (<em>node_modules</em>) in the repository, which you would have anyways downloaded when doing a &lsquo;<a href="https://docs.npmjs.com/cli/install">npm install</a>&rsquo;.</p>

<p>Hope this helps you to get started with React!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-capitalize">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-05-02T13:26:59+00:00"  data-updated="true" itemprop="datePublished dateCreated">May 2<sup>nd</sup>, 2016</time>
        

<span class="glyphicon glyphicon-tags"></span>&nbsp; Posted in&nbsp; 
<span class="categories">
  
    <a class='category' href='/blog/category/programming/'>programming</a>
  
</span>


        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/disable-nuget-package-restore-for-a-net-poject/" itemprop="url">Disable NuGet Package Restore for a .Net Poject</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><em>If you have decided on <a href="http://www.rahulpnath.com/blog/checking-in-package-dependencies-into-source-control/">Checking in Package Dependencies into Source Control</a> for an existing project that uses Nuget Packages then this post is for you</em></p>

<p>When using NuGet package references that are not included in the source control, these packages gets restored during build time. There are <a href="https://docs.nuget.org/consume/package-restore">multiple ways that NuGet supports restore these dependencies at build time</a></p>

<ul>
<li>Automatic Package Restore is the current recommended approach (within Visual Studio), which is available from NuGet 2.7.</li>
<li>Command-line package restore on build servers</li>
<li>MSBuild-integrated package restore approach is the original Package Restore implementation and is still used in many projects.</li>
</ul>


<p>Depending on the type to of restore the project uses, NuGet has different configuration entries in the <em>csproj</em> files and <em>.nuget</em> folder in the solution root. So when choosing to check in package dependencies into the source control, it is a good idea to remove all these <a href="https://docs.nuget.org/consume/package-restore/migrating-to-automatic-package-restore">generated configurations</a> and files that are not required any more. The below script does this for you!</p>

<div class="alert alert-warning">
<strong>WARNING!</strong> The script deletes the <em>.nuget</em> folder (if it exists), updates the <em>.csproj</em> files. Please make sure that the project folder is under source control or you have a backup of the folder. After running the script make sure that all the changes that you see are expected as explained here and the project builds and runs as before.
</div>


<p>The PowerShell script does the below for a given solution directory folder (mandatory)</p>

<ul>
<li>For each of the <em>csproj</em> file in the given folder, the script removes the

<ul>
<li><em>RestorePackages</em> node</li>
<li><em>NugetPackageImportStamp</em> node</li>
<li><em>nuget target import</em> from the solution root .nuget folder</li>
<li><em>EnsureNuGetPackageBuildImports</em> node</li>
</ul>
</li>
<li>Removes <em>.nuget</em> folder from the solution root if it exists.</li>
</ul>


<p><em>The script leaves blank lines in the </em>csproj<em> files in place of the removed nodes.</em></p>

<figure class='code'><figcaption><span>Remove NuGet Restore</span><a href='https://gist.github.com/rahulpnath/13d3b4f54cec51e22344876b1566b911#file-remove-nuget-restore-ps1'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="k">param</span><span class="p">([</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$true</span><span class="p">)]</span><span class="no">[string]</span><span class="nv">$solutionDirectory</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="nv">$importNugetTargetsTag</span><span class="p">=</span> <span class="no">[regex]</span><span class="p">::</span><span class="n">escape</span><span class="p">(</span><span class="sh">@&#39;</span>
</span><span class='line'><span class="sh">&lt;Import Project=&quot;$(SolutionDir)\.nuget\NuGet.targets&quot; Condition=&quot;Exists(&#39;$(SolutionDir)\.nuget\NuGet.targets&#39;)&quot; /&gt;</span>
</span><span class='line'><span class="sh">&#39;@</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$restorePackagesTag</span> <span class="p">=</span> <span class="s1">&#39;&lt;RestorePackages&gt;.*?&lt;/RestorePackages&gt;&#39;</span>
</span><span class='line'><span class="nv">$nuGetPackageImportStamp</span> <span class="p">=</span> <span class="s1">&#39;&lt;NuGetPackageImportStamp&gt;.*?&lt;/NuGetPackageImportStamp&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$EnsureNuGetPackageBuildImportsTargetTag</span> <span class="p">=</span> <span class="s1">&#39;(?smi)&lt;Target Name=&quot;EnsureNuGetPackageBuildImports&quot;.*?&lt;/Target&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="nv">$f</span> <span class="k">in</span> <span class="nb">Get-ChildItem</span> <span class="n">-Recurse</span> <span class="n">-Path</span> <span class="nv">$solutionDirectory</span> <span class="n">-Filter</span> <span class="p">*.</span><span class="n">csproj</span> <span class="p">|</span> <span class="nb">sort-object</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="nv">$f</span><span class="p">.</span><span class="n">FullName</span> <span class="n">-Raw</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="p">`</span>
</span><span class='line'>        <span class="o">-replace</span> <span class="nv">$importNugetTargetsTag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">`</span>
</span><span class='line'>        <span class="o">-replace</span> <span class="nv">$nuGetPackageImportStamp</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">`</span>
</span><span class='line'>        <span class="o">-replace</span> <span class="nv">$restorePackagesTag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">`</span>
</span><span class='line'>        <span class="o">-replace</span> <span class="nv">$EnsureNuGetPackageBuildImportsTargetTag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">`</span>
</span><span class='line'>        <span class="p">|</span> <span class="nb">set-content</span> <span class="nv">$f</span><span class="p">.</span><span class="n">FullName</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$solutionDirectory</span> <span class="n">-include</span> <span class="p">.</span><span class="n">nuget</span> <span class="n">-Recurse</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_</span><span class="p">)</span> <span class="p">{</span> <span class="nb">remove-item</span> <span class="nv">$_</span><span class="p">.</span><span class="n">fullname</span> <span class="n">-Force</span> <span class="n">-Recurse</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Any similarity with the scripts <a href="http://weblogs.asp.net/jongalloway/scripting-net-project-migration-to-automatic-nuget-package-restore">here</a> is intended as that was my starting place. To explicitly <a href="https://docs.nuget.org/consume/package-restore#opting-out">opt out of the Automatic Package Restore</a> on Visual Studio add a <em>Nuget.config</em> in the solution root.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;packageRestore&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- Opts out of both Automatic Package Restore and MSBuild-Integrated Package Restore --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;enabled&quot;</span> <span class="na">value=</span><span class="s">&quot;False&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Opts out of Automatic Package Restore in Visual Studio --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">&quot;automatic&quot;</span> <span class="na">value=</span><span class="s">&quot;False&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/packageRestore&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Hope this helps you to move away from NuGet restore at build time.</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/blog/page/3">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="/index.html">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/introduce-tests-when-fixing-bugs/">Introduce Tests when Fixing Bugs</a>
    
    <a class="list-group-item " href="/blog/keeping-sensitive-configuration-data-out-of-source-control/">Keeping Sensitive Configuration Data Out of Source Control</a>
    
    <a class="list-group-item " href="/blog/automatic_deployment_of_future_posts_with_octopress/">Automatic Deployment of Future Posts With Octopress</a>
    
    <a class="list-group-item " href="/blog/continuos-delivery-of-octopress-blog-using-travisci-and-docker/">Continuos Delivery of Octopress Blog Using TravisCI and Docker</a>
    
    <a class="list-group-item " href="/blog/data_hotfix/">Data Hotfix : Things to Remember</a>
    
  </div>
</section>
<section>
    <a href="https://msdn.microsoft.com/en-us/magazine/mt149362?author=Rahul+Nath">
        <img src="/images/msdn_magazine_aside.jpg" alt="MSDN Magazine Author">
    </a>
</section>



<section class="googleplus googleplus-hidden panel panel-default">
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/+RahulNath?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2016 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'rahulpnath';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
